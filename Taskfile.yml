# Root Taskfile: orchestrator only. Delegates to service Taskfiles via includes.
#
# Service contract: lint, test, test:coverage, test:race, (vuln for Go), build, (vendor for Go), (migrate:* for DB services)
version: '3'

includes:
  auth:
    taskfile: ./auth/Taskfile.yml
    dir: ./auth
  classifier:
    taskfile: ./classifier/Taskfile.yml
    dir: ./classifier
  crawler:
    taskfile: ./crawler/Taskfile.yml
    dir: ./crawler
  dashboard:
    taskfile: ./dashboard/Taskfile.yml
    dir: ./dashboard
  index-manager:
    taskfile: ./index-manager/Taskfile.yml
    dir: ./index-manager
  mcp-north-cloud:
    taskfile: ./mcp-north-cloud/Taskfile.yml
    dir: ./mcp-north-cloud
  nc-http-proxy:
    taskfile: ./nc-http-proxy/Taskfile.yml
    dir: ./nc-http-proxy
  pipeline:
    taskfile: ./pipeline/Taskfile.yml
    dir: ./pipeline
  publisher:
    taskfile: ./publisher/Taskfile.yml
    dir: ./publisher
  search:
    taskfile: ./search/Taskfile.yml
    dir: ./search
  search-frontend:
    taskfile: ./search-frontend/Taskfile.yml
    dir: ./search-frontend
  source-manager:
    taskfile: ./source-manager/Taskfile.yml
    dir: ./source-manager

dotenv: ['.env']

tasks:
  default:
    desc: "Show available tasks"
    cmds:
      - task --list

  ci:
    desc: "Run lint, test, and vuln (CI pipeline)"
    cmds:
      - task: lint
      - task: test
      - task: vuln

  ci:changed:
    desc: "Run lint, test, and vuln only for changed services (vs HEAD~1)"
    cmds:
      - task: lint:changed
      - task: test:changed
      - task: vuln:changed

  lint:changed:
    desc: "Lint only services that have changed (vs HEAD~1 or BASE_REF env var)"
    cmds:
      - |
        SERVICES=$(./scripts/detect-changed-services.sh "${BASE_REF:-HEAD~1}")
        echo "Changed services: $SERVICES"
        if echo "$SERVICES" | grep -q '"all"'; then
          echo "Infrastructure changed - linting all services"
          task lint
        elif [ "$SERVICES" = "[]" ]; then
          echo "No services changed"
        else
          for service in $(echo "$SERVICES" | jq -r '.[]'); do
            echo "=== Linting $service ==="
            task "lint:$service"
          done
        fi

  test:changed:
    desc: "Test only services that have changed (vs HEAD~1 or BASE_REF env var)"
    cmds:
      - |
        SERVICES=$(./scripts/detect-changed-services.sh "${BASE_REF:-HEAD~1}")
        echo "Changed services: $SERVICES"
        if echo "$SERVICES" | grep -q '"all"'; then
          echo "Infrastructure changed - testing all services"
          task test
        elif [ "$SERVICES" = "[]" ]; then
          echo "No services changed"
        else
          for service in $(echo "$SERVICES" | jq -r '.[]'); do
            echo "=== Testing $service ==="
            task "test:$service"
          done
        fi

  vuln:changed:
    desc: "Vulnerability check only for changed Go services (vs HEAD~1 or BASE_REF env var)"
    cmds:
      - |
        SERVICES=$(./scripts/detect-changed-services.sh "${BASE_REF:-HEAD~1}")
        echo "Changed services: $SERVICES"
        GO_SERVICES="auth classifier crawler index-manager mcp-north-cloud nc-http-proxy pipeline publisher search source-manager"
        if echo "$SERVICES" | grep -q '"all"'; then
          echo "Infrastructure changed - checking all services"
          task vuln
        elif [ "$SERVICES" = "[]" ]; then
          echo "No services changed"
        else
          for service in $(echo "$SERVICES" | jq -r '.[]'); do
            if echo "$GO_SERVICES" | grep -qw "$service"; then
              echo "=== Vulnerability check $service ==="
              task "vuln:$service"
            fi
          done
        fi

  lint:
    desc: "Run linters for all microservices sequentially"
    cmds:
      - task: lint:auth
      - task: lint:classifier
      - task: lint:crawler
      - task: lint:dashboard
      - task: lint:index-manager
      - task: lint:mcp-north-cloud
      - task: lint:nc-http-proxy
      - task: lint:pipeline
      - task: lint:publisher
      - task: lint:search
      - task: lint:search-frontend
      - task: lint:source-manager

  lint:force:
    desc: "Run linters for all services (ignore cache). Use before pushing to match CI."
    cmds:
      - task: lint:auth:force
      - task: lint:classifier:force
      - task: lint:crawler:force
      - task: lint:dashboard:force
      - task: lint:index-manager:force
      - task: lint:mcp-north-cloud:force
      - task: lint:nc-http-proxy:force
      - task: lint:pipeline:force
      - task: lint:publisher:force
      - task: lint:search:force
      - task: lint:search-frontend:force
      - task: lint:source-manager:force

  lint:auth:force:
    desc: "Run auth linter (ignore cache)"
    cmds:
      - task auth:lint -f
  lint:classifier:force:
    desc: "Run classifier linter (ignore cache)"
    cmds:
      - task classifier:lint -f
  lint:crawler:force:
    desc: "Run crawler linter (ignore cache)"
    cmds:
      - task crawler:lint -f
  lint:dashboard:force:
    desc: "Run dashboard linter (ignore cache)"
    cmds:
      - task dashboard:lint -f
  lint:index-manager:force:
    desc: "Run index-manager linter (ignore cache)"
    cmds:
      - task index-manager:lint -f
  lint:mcp-north-cloud:force:
    desc: "Run mcp-north-cloud linter (ignore cache)"
    cmds:
      - task mcp-north-cloud:lint -f
  lint:nc-http-proxy:force:
    desc: "Run nc-http-proxy linter (ignore cache)"
    cmds:
      - task nc-http-proxy:lint -f
  lint:pipeline:force:
    desc: "Run pipeline linter (ignore cache)"
    cmds:
      - task pipeline:lint -f
  lint:publisher:force:
    desc: "Run publisher linter (ignore cache)"
    cmds:
      - task publisher:lint -f
  lint:search:force:
    desc: "Run search linter (ignore cache)"
    cmds:
      - task search:lint -f
  lint:search-frontend:force:
    desc: "Run search-frontend linter (ignore cache)"
    cmds:
      - task search-frontend:lint -f
  lint:source-manager:force:
    desc: "Run source-manager linter (ignore cache)"
    cmds:
      - task source-manager:lint -f

  lint:parallel:
    desc: "Run linters for all microservices in parallel"
    cmds:
      - task: lint:auth
      - task: lint:classifier
      - task: lint:crawler
      - task: lint:dashboard
      - task: lint:index-manager
      - task: lint:mcp-north-cloud
      - task: lint:nc-http-proxy
      - task: lint:pipeline
      - task: lint:publisher
      - task: lint:search
      - task: lint:search-frontend
      - task: lint:source-manager

  lint:auth:
    desc: "Run linter for auth service"
    cmds:
      - task auth:lint

  lint:classifier:
    desc: "Run linter for classifier service"
    cmds:
      - task classifier:lint

  lint:crawler:
    desc: "Run linter for crawler service"
    cmds:
      - task crawler:lint

  lint:dashboard:
    desc: "Run linter for dashboard service"
    cmds:
      - task dashboard:lint

  lint:index-manager:
    desc: "Run linter for index-manager service"
    cmds:
      - task index-manager:lint

  lint:mcp-north-cloud:
    desc: "Run linter for mcp-north-cloud service"
    cmds:
      - task mcp-north-cloud:lint

  lint:nc-http-proxy:
    desc: "Run linter for nc-http-proxy"
    cmds:
      - task nc-http-proxy:lint

  lint:pipeline:
    desc: "Run linter for pipeline service"
    cmds:
      - task pipeline:lint

  lint:publisher:
    desc: "Run linter for publisher service"
    cmds:
      - task publisher:lint

  lint:search:
    desc: "Run linter for search service"
    cmds:
      - task search:lint

  lint:search-frontend:
    desc: "Run linter for search-frontend service"
    cmds:
      - task search-frontend:lint

  lint:source-manager:
    desc: "Run linter for source-manager service"
    cmds:
      - task source-manager:lint

  mcp:build:
    desc: "Build the MCP North Cloud server binary (for Cursor/Claude Code)"
    cmds:
      - task mcp-north-cloud:build

  vendor:
    desc: "Run go mod vendor in each Go module (run after dependency changes)"
    cmds:
      - task auth:vendor
      - task classifier:vendor
      - task crawler:vendor
      - task index-manager:vendor
      - task mcp-north-cloud:vendor
      - task nc-http-proxy:vendor
      - task pipeline:vendor
      - task publisher:vendor
      - task search:vendor
      - task source-manager:vendor
      - task: vendor:infrastructure

  vendor:infrastructure:
    desc: "Vendor infrastructure module"
    dir: infrastructure
    env: { GOWORK: "off" }
    cmds:
      - go mod vendor

  vuln:
    desc: "Run vulnerability check for all Go microservices"
    cmds:
      - task auth:vuln
      - task classifier:vuln
      - task crawler:vuln
      - task index-manager:vuln
      - task mcp-north-cloud:vuln
      - task nc-http-proxy:vuln
      - task pipeline:vuln
      - task publisher:vuln
      - task search:vuln
      - task source-manager:vuln

  vuln:auth:
    desc: "Run vulnerability check for auth service"
    cmds:
      - task auth:vuln

  vuln:classifier:
    desc: "Run vulnerability check for classifier service"
    cmds:
      - task classifier:vuln

  vuln:crawler:
    desc: "Run vulnerability check for crawler service"
    cmds:
      - task crawler:vuln

  vuln:index-manager:
    desc: "Run vulnerability check for index-manager service"
    cmds:
      - task index-manager:vuln

  vuln:mcp-north-cloud:
    desc: "Run vulnerability check for mcp-north-cloud service"
    cmds:
      - task mcp-north-cloud:vuln

  vuln:nc-http-proxy:
    desc: "Run vulnerability check for nc-http-proxy"
    cmds:
      - task nc-http-proxy:vuln

  vuln:pipeline:
    desc: "Run vulnerability check for pipeline service"
    cmds:
      - task pipeline:vuln

  vuln:publisher:
    desc: "Run vulnerability check for publisher service"
    cmds:
      - task publisher:vuln

  vuln:search:
    desc: "Run vulnerability check for search service"
    cmds:
      - task search:vuln

  vuln:source-manager:
    desc: "Run vulnerability check for source-manager service"
    cmds:
      - task source-manager:vuln

  test:
    desc: "Run tests for all microservices sequentially"
    cmds:
      - task: test:auth
      - task: test:classifier
      - task: test:crawler
      - task: test:dashboard
      - task: test:index-manager
      - task: test:mcp-north-cloud
      - task: test:nc-http-proxy
      - task: test:pipeline
      - task: test:publisher
      - task: test:search
      - task: test:search-frontend
      - task: test:source-manager
      - task: test:contracts

  test:parallel:
    desc: "Run tests for all microservices in parallel"
    cmds:
      - task: test:auth
      - task: test:classifier
      - task: test:crawler
      - task: test:dashboard
      - task: test:index-manager
      - task: test:mcp-north-cloud
      - task: test:nc-http-proxy
      - task: test:pipeline
      - task: test:publisher
      - task: test:search
      - task: test:search-frontend
      - task: test:source-manager

  test:auth:
    desc: "Run tests for auth service"
    cmds:
      - task auth:test

  test:classifier:
    desc: "Run tests for classifier service"
    cmds:
      - task classifier:test

  test:crawler:
    desc: "Run tests for crawler service"
    cmds:
      - task crawler:test

  test:dashboard:
    desc: "Run tests for dashboard service"
    cmds:
      - task dashboard:test

  test:index-manager:
    desc: "Run tests for index-manager service"
    cmds:
      - task index-manager:test

  test:mcp-north-cloud:
    desc: "Run tests for mcp-north-cloud service"
    cmds:
      - task mcp-north-cloud:test

  test:nc-http-proxy:
    desc: "Run tests for nc-http-proxy"
    cmds:
      - task nc-http-proxy:test

  test:pipeline:
    desc: "Run tests for pipeline service"
    cmds:
      - task pipeline:test

  test:publisher:
    desc: "Run tests for publisher service"
    cmds:
      - task publisher:test

  test:search:
    desc: "Run tests for search service"
    cmds:
      - task search:test

  test:search-frontend:
    desc: "Run tests for search-frontend service"
    cmds:
      - task search-frontend:test

  test:source-manager:
    desc: "Run tests for source-manager service"
    cmds:
      - task source-manager:test

  test:race:
    desc: "Run tests with race detector for all microservices sequentially"
    cmds:
      - task: test:race:auth
      - task: test:race:classifier
      - task: test:race:crawler
      - task: test:race:dashboard
      - task: test:race:index-manager
      - task: test:race:mcp-north-cloud
      - task: test:race:nc-http-proxy
      - task: test:race:pipeline
      - task: test:race:publisher
      - task: test:race:search
      - task: test:race:search-frontend
      - task: test:race:source-manager

  test:race:parallel:
    desc: "Run tests with race detector for all microservices in parallel"
    cmds:
      - task: test:race:auth
      - task: test:race:classifier
      - task: test:race:crawler
      - task: test:race:dashboard
      - task: test:race:index-manager
      - task: test:race:mcp-north-cloud
      - task: test:race:nc-http-proxy
      - task: test:race:pipeline
      - task: test:race:publisher
      - task: test:race:search
      - task: test:race:search-frontend
      - task: test:race:source-manager

  test:race:auth:
    desc: "Run tests with race detector for auth service"
    cmds:
      - task auth:test:race

  test:race:classifier:
    desc: "Run tests with race detector for classifier service"
    cmds:
      - task classifier:test:race

  test:race:crawler:
    desc: "Run tests with race detector for crawler service"
    cmds:
      - task crawler:test:race

  test:race:dashboard:
    desc: "Run tests with race detector for dashboard service"
    cmds:
      - task dashboard:test:race

  test:race:index-manager:
    desc: "Run tests with race detector for index-manager service"
    cmds:
      - task index-manager:test:race

  test:race:mcp-north-cloud:
    desc: "Run tests with race detector for mcp-north-cloud service"
    cmds:
      - task mcp-north-cloud:test:race

  test:race:nc-http-proxy:
    desc: "Run tests with race detector for nc-http-proxy"
    cmds:
      - task nc-http-proxy:test:race

  test:race:pipeline:
    desc: "Run tests with race detector for pipeline service"
    cmds:
      - task pipeline:test:race

  test:race:publisher:
    desc: "Run tests with race detector for publisher service"
    cmds:
      - task publisher:test:race

  test:race:search:
    desc: "Run tests with race detector for search service"
    cmds:
      - task search:test:race

  test:race:search-frontend:
    desc: "Run tests with race detector for search-frontend service"
    cmds:
      - task search-frontend:test:race

  test:race:source-manager:
    desc: "Run tests with race detector for source-manager service"
    cmds:
      - task source-manager:test:race

  test:cover:
    desc: "Run tests with coverage for all microservices sequentially"
    cmds:
      - task: test:cover:auth
      - task: test:cover:classifier
      - task: test:cover:crawler
      - task: test:cover:dashboard
      - task: test:cover:index-manager
      - task: test:cover:mcp-north-cloud
      - task: test:cover:nc-http-proxy
      - task: test:cover:pipeline
      - task: test:cover:publisher
      - task: test:cover:search
      - task: test:cover:search-frontend
      - task: test:cover:source-manager

  test:cover:parallel:
    desc: "Run tests with coverage for all microservices in parallel"
    cmds:
      - task: test:cover:auth
      - task: test:cover:classifier
      - task: test:cover:crawler
      - task: test:cover:dashboard
      - task: test:cover:index-manager
      - task: test:cover:mcp-north-cloud
      - task: test:cover:nc-http-proxy
      - task: test:cover:pipeline
      - task: test:cover:publisher
      - task: test:cover:search
      - task: test:cover:search-frontend
      - task: test:cover:source-manager

  test:cover:auth:
    desc: "Run tests with coverage for auth service"
    cmds:
      - task auth:test:coverage

  test:cover:classifier:
    desc: "Run tests with coverage for classifier service"
    cmds:
      - task classifier:test:coverage

  test:cover:crawler:
    desc: "Run tests with coverage for crawler service"
    cmds:
      - task crawler:test:coverage

  test:cover:dashboard:
    desc: "Run tests with coverage for dashboard service"
    cmds:
      - task dashboard:test:coverage

  test:cover:index-manager:
    desc: "Run tests with coverage for index-manager service"
    cmds:
      - task index-manager:test:coverage

  test:cover:mcp-north-cloud:
    desc: "Run tests with coverage for mcp-north-cloud service"
    cmds:
      - task mcp-north-cloud:test:coverage

  test:cover:nc-http-proxy:
    desc: "Run tests with coverage for nc-http-proxy"
    cmds:
      - task nc-http-proxy:test:coverage

  test:cover:pipeline:
    desc: "Run tests with coverage for pipeline service"
    cmds:
      - task pipeline:test:coverage

  test:cover:publisher:
    desc: "Run tests with coverage for publisher service"
    cmds:
      - task publisher:test:coverage

  test:cover:search:
    desc: "Run tests with coverage for search service"
    cmds:
      - task search:test:coverage

  test:cover:search-frontend:
    desc: "Run tests with coverage for search-frontend service"
    cmds:
      - task search-frontend:test:coverage

  test:cover:source-manager:
    desc: "Run tests with coverage for source-manager service"
    cmds:
      - task source-manager:test:coverage

  migrate:up:
    desc: "Run database migrations for all microservices sequentially"
    cmds:
      - task: migrate:crawler
      - task: migrate:source-manager
      - task: migrate:classifier
      - task: migrate:publisher
      - task: migrate:index-manager
      - task: migrate:pipeline

  migrate:down:
    desc: "Rollback last migration for all microservices sequentially"
    cmds:
      - task: migrate:down:crawler
      - task: migrate:down:source-manager
      - task: migrate:down:classifier
      - task: migrate:down:publisher
      - task: migrate:down:index-manager
      - task: migrate:down:pipeline

  migrate:version:
    desc: "Show migration version for all microservices"
    cmds:
      - task: migrate:version:crawler
      - task: migrate:version:source-manager
      - task: migrate:version:classifier
      - task: migrate:version:publisher
      - task: migrate:version:index-manager
      - task: migrate:version:pipeline

  migrate:crawler:
    desc: "Run database migrations for crawler service"
    cmds:
      - task crawler:migrate:up

  migrate:down:crawler:
    desc: "Rollback last migration for crawler service"
    cmds:
      - task crawler:migrate:down

  migrate:version:crawler:
    desc: "Show migration version for crawler service"
    cmds:
      - task crawler:migrate:version

  migrate:force:crawler:
    desc: "Force crawler database to a specific migration version (use to fix dirty state)"
    cmds:
      - task crawler:migrate:force

  migrate:source-manager:
    desc: "Run database migrations for source-manager service"
    cmds:
      - task source-manager:migrate:up

  migrate:down:source-manager:
    desc: "Rollback last migration for source-manager service"
    cmds:
      - task source-manager:migrate:down

  migrate:version:source-manager:
    desc: "Show migration version for source-manager service"
    cmds:
      - task source-manager:migrate:version

  migrate:force:source-manager:
    desc: "Force source-manager database to a specific migration version (use to fix dirty state)"
    cmds:
      - task source-manager:migrate:force

  migrate:classifier:
    desc: "Run database migrations for classifier service"
    cmds:
      - task classifier:migrate:up

  migrate:down:classifier:
    desc: "Rollback last migration for classifier service"
    cmds:
      - task classifier:migrate:down

  migrate:version:classifier:
    desc: "Show migration version for classifier service"
    cmds:
      - task classifier:migrate:version

  migrate:force:classifier:
    desc: "Force classifier database to a specific migration version (use to fix dirty state)"
    cmds:
      - task classifier:migrate:force

  migrate:publisher:
    desc: "Run database migrations for publisher service"
    cmds:
      - task publisher:migrate:up

  migrate:down:publisher:
    desc: "Rollback last migration for publisher service"
    cmds:
      - task publisher:migrate:down

  migrate:version:publisher:
    desc: "Show migration version for publisher service"
    cmds:
      - task publisher:migrate:version

  migrate:force:publisher:
    desc: "Force publisher database to a specific migration version (use to fix dirty state)"
    cmds:
      - task publisher:migrate:force

  migrate:index-manager:
    desc: "Run database migrations for index-manager service"
    cmds:
      - task index-manager:migrate:up

  migrate:down:index-manager:
    desc: "Rollback last migration for index-manager service"
    cmds:
      - task index-manager:migrate:down

  migrate:version:index-manager:
    desc: "Show migration version for index-manager service"
    cmds:
      - task index-manager:migrate:version

  migrate:force:index-manager:
    desc: "Force index-manager database to a specific migration version (use to fix dirty state)"
    cmds:
      - task index-manager:migrate:force

  migrate:pipeline:
    desc: "Run database migrations for pipeline service"
    cmds:
      - task pipeline:migrate:up

  migrate:down:pipeline:
    desc: "Rollback last migration for pipeline service"
    cmds:
      - task pipeline:migrate:down

  migrate:version:pipeline:
    desc: "Show migration version for pipeline service"
    cmds:
      - task pipeline:migrate:version

  migrate:force:pipeline:
    desc: "Force pipeline database to a specific migration version (use to fix dirty state)"
    cmds:
      - task pipeline:migrate:force

  config:init:
    desc: "Copy all config.yml.example files to config.yml"
    cmds:
      - cp auth/config.yml.example auth/config.yml
      - cp classifier/config.yml.example classifier/config.yml
      - cp index-manager/config.yml.example index-manager/config.yml
      - cp publisher/config.yml.example publisher/config.yml
      - cp search/config.yml.example search/config.yml
      - cp source-manager/config.yml.example source-manager/config.yml

  install:tools:
    desc: "Install development tools"
    cmds:
      - go install github.com/air-verse/air@latest || true
      - go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.8.0 || true
      - go install golang.org/x/tools/cmd/goimports@latest || true
      - go install github.com/golang-migrate/migrate/v4/cmd/migrate@latest || true
      - go install golang.org/x/vuln/cmd/govulncheck@latest || true

  # Docker lifecycle
  docker:dev:up:
    desc: "Start development environment (core services only)"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml up -d {{.CLI_ARGS}}

  docker:dev:up:observability:
    desc: "Start development environment including Loki, Alloy, Grafana, Pyroscope"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml --profile observability up -d {{.CLI_ARGS}}

  docker:dev:up:search:
    desc: "Start development environment including search-service and search-frontend"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml --profile search up -d {{.CLI_ARGS}}

  docker:dev:down:
    desc: "Stop development environment"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml down {{.CLI_ARGS}}

  docker:dev:logs:
    desc: "View development environment logs"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml logs -f

  docker:dev:restart:
    desc: "Restart development environment"
    cmds:
      - task: docker:dev:down
      - task: docker:dev:up

  docker:dev:build:
    desc: "Build development Docker images"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml build {{.CLI_ARGS}}

  docker:prod:up:
    desc: "Start production environment"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.prod.yml up -d {{.CLI_ARGS}}

  docker:prod:down:
    desc: "Stop production environment"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.prod.yml down {{.CLI_ARGS}}

  docker:prod:logs:
    desc: "View production environment logs"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.prod.yml logs -f {{.CLI_ARGS}}

  docker:prod:restart:
    desc: "Restart production environment"
    cmds:
      - task: docker:prod:down
      - task: docker:prod:up

  docker:prod:build:
    desc: "Build production Docker images"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.prod.yml build {{.CLI_ARGS}}

  # Per-service Docker shortcuts
  docker:dev:up:crawler:
    desc: "Start crawler service and dependencies"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml up -d crawler

  docker:dev:down:crawler:
    desc: "Stop crawler service"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml stop crawler

  docker:dev:logs:crawler:
    desc: "View crawler service logs"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml logs -f {{.CLI_ARGS}} crawler

  docker:dev:build:crawler:
    desc: "Build crawler service image"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml build crawler

  docker:dev:restart:crawler:
    desc: "Restart crawler service"
    cmds:
      - task: docker:dev:down:crawler
      - task: docker:dev:up:crawler

  docker:dev:up:source-manager:
    desc: "Start source-manager service and dependencies"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml up -d source-manager

  docker:dev:down:source-manager:
    desc: "Stop source-manager service"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml stop source-manager

  docker:dev:logs:source-manager:
    desc: "View source-manager service logs"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml logs -f {{.CLI_ARGS}} source-manager

  docker:dev:build:source-manager:
    desc: "Build source-manager service image"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml build source-manager

  docker:dev:restart:source-manager:
    desc: "Restart source-manager service"
    cmds:
      - task: docker:dev:down:source-manager
      - task: docker:dev:up:source-manager

  docker:dev:up:publisher:
    desc: "Start publisher service and dependencies"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml up -d publisher

  docker:dev:down:publisher:
    desc: "Stop publisher service"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml stop publisher

  docker:dev:logs:publisher:
    desc: "View publisher service logs"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml logs -f {{.CLI_ARGS}} publisher

  docker:dev:build:publisher:
    desc: "Build publisher service image"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml build publisher

  docker:dev:restart:publisher:
    desc: "Restart publisher service"
    cmds:
      - task: docker:dev:down:publisher
      - task: docker:dev:up:publisher

  docker:dev:up:classifier:
    desc: "Start classifier service and dependencies"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml up -d classifier

  docker:dev:down:classifier:
    desc: "Stop classifier service"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml stop classifier

  docker:dev:logs:classifier:
    desc: "View classifier service logs"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml logs -f {{.CLI_ARGS}} classifier

  docker:dev:build:classifier:
    desc: "Build classifier service image"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml build classifier

  docker:dev:restart:classifier:
    desc: "Restart classifier service"
    cmds:
      - task: docker:dev:down:classifier
      - task: docker:dev:up:classifier

  docker:dev:up:auth:
    desc: "Start auth service"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml up -d auth

  docker:dev:down:auth:
    desc: "Stop auth service"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml stop auth

  docker:dev:logs:auth:
    desc: "View auth service logs"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml logs -f {{.CLI_ARGS}} auth

  docker:dev:build:auth:
    desc: "Build auth service image"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml build auth

  docker:dev:restart:auth:
    desc: "Restart auth service"
    cmds:
      - task: docker:dev:down:auth
      - task: docker:dev:up:auth

  docker:dev:up:index-manager:
    desc: "Start index-manager service and dependencies"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml up -d index-manager

  docker:dev:down:index-manager:
    desc: "Stop index-manager service"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml stop index-manager

  docker:dev:logs:index-manager:
    desc: "View index-manager service logs"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml logs -f {{.CLI_ARGS}} index-manager

  docker:dev:build:index-manager:
    desc: "Build index-manager service image"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml build index-manager

  docker:dev:restart:index-manager:
    desc: "Restart index-manager service"
    cmds:
      - task: docker:dev:down:index-manager
      - task: docker:dev:up:index-manager

  docker:dev:up:search-service:
    desc: "Start search-service and dependencies"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml up -d search-service

  docker:dev:down:search-service:
    desc: "Stop search-service"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml stop search-service

  docker:dev:logs:search-service:
    desc: "View search-service logs"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml logs -f {{.CLI_ARGS}} search-service

  docker:dev:build:search-service:
    desc: "Build search-service image"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml build search-service

  docker:dev:restart:search-service:
    desc: "Restart search-service"
    cmds:
      - task: docker:dev:down:search-service
      - task: docker:dev:up:search-service

  docker:dev:up:search-frontend:
    desc: "Start search-frontend and dependencies"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml up -d search-frontend

  docker:dev:down:search-frontend:
    desc: "Stop search-frontend"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml stop search-frontend

  docker:dev:logs:search-frontend:
    desc: "View search-frontend logs"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml logs -f {{.CLI_ARGS}} search-frontend

  docker:dev:build:search-frontend:
    desc: "Build search-frontend image"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml build search-frontend

  docker:dev:restart:search-frontend:
    desc: "Restart search-frontend"
    cmds:
      - task: docker:dev:down:search-frontend
      - task: docker:dev:up:search-frontend

  docker:dev:up:dashboard:
    desc: "Start dashboard and dependencies"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml up -d dashboard

  docker:dev:down:dashboard:
    desc: "Stop dashboard"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml stop dashboard

  docker:dev:logs:dashboard:
    desc: "View dashboard logs"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml logs -f {{.CLI_ARGS}} dashboard

  docker:dev:build:dashboard:
    desc: "Build dashboard image"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml build dashboard

  docker:dev:restart:dashboard:
    desc: "Restart dashboard"
    cmds:
      - task: docker:dev:down:dashboard
      - task: docker:dev:up:dashboard

  docker:dev:up:nginx:
    desc: "Start nginx and dependencies"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml up -d nginx

  docker:dev:down:nginx:
    desc: "Stop nginx"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml stop nginx

  docker:dev:logs:nginx:
    desc: "View nginx logs"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml logs -f {{.CLI_ARGS}} nginx

  docker:dev:build:nginx:
    desc: "Build nginx image"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml build nginx

  docker:dev:restart:nginx:
    desc: "Restart nginx"
    cmds:
      - task: docker:dev:down:nginx
      - task: docker:dev:up:nginx

  docker:dev:up:pyroscope:
    desc: "Start pyroscope"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml up -d pyroscope

  docker:dev:down:pyroscope:
    desc: "Stop pyroscope"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml stop pyroscope

  docker:dev:logs:pyroscope:
    desc: "View pyroscope logs"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml logs -f {{.CLI_ARGS}} pyroscope

  docker:dev:build:pyroscope:
    desc: "Build pyroscope image"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml build pyroscope

  docker:dev:restart:pyroscope:
    desc: "Restart pyroscope"
    cmds:
      - task: docker:dev:down:pyroscope
      - task: docker:dev:up:pyroscope

  # Database backup/restore/sync
  db:backup:
    desc: "Backup database for a service (usage: task db:backup -- crawler)"
    cmds:
      - ./scripts/db-backup.sh {{.CLI_ARGS}}

  db:backup:all:
    desc: "Backup all databases"
    cmds:
      - ./scripts/db-backup.sh all

  db:backup:crawler:
    desc: "Backup crawler database"
    cmds:
      - ./scripts/db-backup.sh crawler

  db:backup:source-manager:
    desc: "Backup source-manager database"
    cmds:
      - ./scripts/db-backup.sh source-manager

  db:backup:classifier:
    desc: "Backup classifier database"
    cmds:
      - ./scripts/db-backup.sh classifier

  db:backup:publisher:
    desc: "Backup publisher database"
    cmds:
      - ./scripts/db-backup.sh publisher

  db:backup:index-manager:
    desc: "Backup index-manager database"
    cmds:
      - ./scripts/db-backup.sh index-manager

  db:restore:
    desc: "Restore database from backup (usage: task db:restore -- crawler ./backups/crawler/backup.sql.gz --confirm)"
    cmds:
      - ./scripts/db-restore.sh {{.CLI_ARGS}}

  db:sync:
    desc: "Sync database from production (usage: task db:sync -- crawler)"
    cmds:
      - ./scripts/db-sync.sh {{.CLI_ARGS}}

  db:sync:all:
    desc: "Sync all databases from production"
    cmds:
      - ./scripts/db-sync.sh all

  db:sync:crawler:
    desc: "Sync crawler database from production"
    cmds:
      - ./scripts/db-sync.sh crawler

  db:sync:source-manager:
    desc: "Sync source-manager database from production"
    cmds:
      - ./scripts/db-sync.sh source-manager

  db:sync:classifier:
    desc: "Sync classifier database from production"
    cmds:
      - ./scripts/db-sync.sh classifier

  db:sync:publisher:
    desc: "Sync publisher database from production"
    cmds:
      - ./scripts/db-sync.sh publisher

  db:sync:index-manager:
    desc: "Sync index-manager database from production"
    cmds:
      - ./scripts/db-sync.sh index-manager

  db:list:
    desc: "List available database backups"
    cmds:
      - ./scripts/db-list.sh {{.CLI_ARGS}}

  # HTTP Replay Proxy
  proxy:up:
    desc: "Start HTTP replay proxy (default: replay mode)"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml up -d nc-http-proxy

  proxy:down:
    desc: "Stop HTTP replay proxy"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml stop nc-http-proxy

  proxy:logs:
    desc: "View HTTP replay proxy logs"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml logs -f {{.CLI_ARGS}} nc-http-proxy

  proxy:build:
    desc: "Build HTTP replay proxy image"
    cmds:
      - docker compose -f docker-compose.base.yml -f docker-compose.dev.yml build nc-http-proxy

  proxy:restart:
    desc: "Restart HTTP replay proxy"
    cmds:
      - task: proxy:down
      - task: proxy:up

  proxy:status:
    desc: "Get HTTP proxy status (mode, cache stats)"
    cmds:
      - curl -s http://localhost:${PROXY_PORT:-8055}/admin/status | jq .

  proxy:mode:replay:
    desc: "Switch proxy to replay mode (fixtures + cache only)"
    cmds:
      - curl -s -X POST http://localhost:${PROXY_PORT:-8055}/admin/mode/replay | jq .

  proxy:mode:record:
    desc: "Switch proxy to record mode (live requests, cache responses)"
    cmds:
      - curl -s -X POST http://localhost:${PROXY_PORT:-8055}/admin/mode/record | jq .

  proxy:mode:live:
    desc: "Switch proxy to live mode (pass-through, no caching)"
    cmds:
      - curl -s -X POST http://localhost:${PROXY_PORT:-8055}/admin/mode/live | jq .

  proxy:list:
    desc: "List cached domains"
    cmds:
      - curl -s http://localhost:${PROXY_PORT:-8055}/admin/cache | jq .

  proxy:clear:
    desc: "Clear proxy cache (keeps fixtures)"
    cmds:
      - curl -s -X DELETE http://localhost:${PROXY_PORT:-8055}/admin/cache | jq .

  # Integration tests
  test:contracts:
    desc: "Run contract tests (verifies services produce/consume valid ES mappings)"
    dir: tests/contracts
    cmds:
      - GOWORK=off go test -v ./...

  test:integration:pipeline:
    desc: "Run pipeline integration test (requires full Docker Compose stack)"
    cmds:
      - |
        echo "Starting test stack..."
        docker compose -f docker-compose.base.yml -f docker-compose.test.yml up -d --build --wait
        echo "Running pipeline integration test..."
        cd tests/integration/pipeline && GOWORK=off go test -tags=integration -v -timeout=10m ./...
        EXIT_CODE=$?
        echo "Tearing down test stack..."
        docker compose -f docker-compose.base.yml -f docker-compose.test.yml down
        exit $EXIT_CODE
