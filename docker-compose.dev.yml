# ============================================================
# YAML Anchors for Dev Services
# ============================================================

x-go-dev-defaults: &go-dev-defaults
  user: "${UID:-1000}:${GID:-1000}"
  networks:
    - north-cloud-network
  restart: unless-stopped
  volumes:
    - /app/vendor
    - ./infrastructure:/infrastructure
  working_dir: /app

x-go-dev-environment: &go-dev-environment
  GOMODCACHE: /tmp/go-mod-cache
  GOCACHE: /tmp/go-build-cache
  APP_DEBUG: "true"
  APP_ENV: development
  ENABLE_PROFILING: "${ENABLE_PROFILING:-true}"
  AUTH_JWT_SECRET: "${AUTH_JWT_SECRET:-}"

x-node-dev-defaults: &node-dev-defaults
  user: "${UID:-1000}:${GID:-1000}"
  networks:
    - north-cloud-network
  restart: unless-stopped
  volumes:
    - /app/node_modules
  working_dir: /app

x-node-dev-environment: &node-dev-environment
  NODE_ENV: development
  npm_config_cache: /tmp/npm-cache

x-service-defaults: &service-defaults
  restart: unless-stopped
  networks:
    - north-cloud-network

# ============================================================
# Development Services
# ============================================================

services:

  # ------------------------------------------------------------
  # Crawler (Dev)
  # ------------------------------------------------------------
  crawler:
    <<: *go-dev-defaults
    build:
      context: ./crawler
      dockerfile: Dockerfile.dev
    ports:
      - "${CRAWLER_PORT:-8060}:8080"
      - "${CRAWLER_PPROF_PORT:-6060}:6060"
    depends_on:
      postgres-crawler:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      <<: *go-dev-environment
      POSTGRES_CRAWLER_HOST: postgres-crawler
      POSTGRES_CRAWLER_PORT: 5432
      POSTGRES_CRAWLER_USER: "${POSTGRES_CRAWLER_USER:-postgres}"
      POSTGRES_CRAWLER_PASSWORD: "${POSTGRES_CRAWLER_PASSWORD:-postgres}"
      POSTGRES_CRAWLER_DB: "${POSTGRES_CRAWLER_DB:-crawler}"
      POSTGRES_CRAWLER_SSLMODE: disable
      SERVER_HOST: "${CRAWLER_HOST:-0.0.0.0}"
      SERVER_PORT: "${CRAWLER_PORT:-8060}"
      CRAWLER_SOURCES_API_URL: "${CRAWLER_SOURCES_API_URL:-http://source-manager:8050/api/v1/sources}"
      CRAWLER_MINIO_ENABLED: "${CRAWLER_MINIO_ENABLED:-true}"
      CRAWLER_MINIO_ENDPOINT: "${CRAWLER_MINIO_ENDPOINT:-minio:9000}"
      CRAWLER_MINIO_ACCESS_KEY: "${CRAWLER_MINIO_ACCESS_KEY:-minioadmin}"
      CRAWLER_MINIO_SECRET_KEY: "${CRAWLER_MINIO_SECRET_KEY:-changeme123}"
      CRAWLER_MINIO_BUCKET: "${CRAWLER_MINIO_BUCKET:-html-archives}"
      CRAWLER_MINIO_METADATA_BUCKET: "${CRAWLER_MINIO_METADATA_BUCKET:-crawler-metadata}"
      CRAWLER_MINIO_USE_SSL: "${CRAWLER_MINIO_USE_SSL:-false}"
      CRAWLER_SAVE_DISCOVERED_LINKS: "${CRAWLER_SAVE_DISCOVERED_LINKS:-true}"
      PPROF_PORT: 6060
    volumes:
      - ./crawler:/app
      - crawler_go_mod_cache:/tmp/go-mod-cache
      - crawler_go_build_cache:/tmp/go-build-cache
      - ./infrastructure:/infrastructure
    command: ["sh", "-c", "go mod download && air -c .air.toml"]
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ------------------------------------------------------------
  # Source Manager (Dev)
  # ------------------------------------------------------------
  source-manager:
    <<: *go-dev-defaults
    build:
      context: .
      dockerfile: ./source-manager/Dockerfile.dev
    ports:
      - "${SOURCE_MANAGER_PORT:-8050}:8050"
      - "${SOURCE_MANAGER_PPROF_PORT:-6061}:6060"
    depends_on:
      postgres-source-manager:
        condition: service_healthy
    environment:
      <<: *go-dev-environment
      SERVER_HOST: "${SOURCE_MANAGER_HOST:-0.0.0.0}"
      SERVER_PORT: "${SOURCE_MANAGER_PORT:-8050}"
      DB_HOST: postgres-source-manager
      DB_PORT: 5432
      DB_USER: "${POSTGRES_SOURCE_MANAGER_USER:-postgres}"
      DB_PASSWORD: "${POSTGRES_SOURCE_MANAGER_PASSWORD:-postgres}"
      DB_NAME: "${POSTGRES_SOURCE_MANAGER_DB:-gosources}"
      DB_SSLMODE: disable
      SOURCE_MANAGER_API_URL: "${SOURCE_MANAGER_API_URL:-http://localhost:8050}"
      PPROF_PORT: 6060
    volumes:
      - ./source-manager:/app
      - ./infrastructure:/infrastructure:ro
      - ./source-manager/migrations:/migrations:ro
      - source_manager_go_mod_cache:/tmp/go-mod-cache
      - source_manager_go_build_cache:/tmp/go-build-cache
    command: ["sh", "-c", "go mod download && air -c .air.toml"]
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8050/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ------------------------------------------------------------
  # Classifier (Dev)
  # ------------------------------------------------------------
  classifier:
    <<: *go-dev-defaults
    build:
      context: ./classifier
      dockerfile: Dockerfile.dev
      args:
        UID: "${UID:-1000}"
        GID: "${GID:-1000}"
    ports:
      - "${CLASSIFIER_PORT:-8071}:8070"
      - "${CLASSIFIER_PPROF_PORT:-6062}:6060"
    depends_on:
      postgres-classifier:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      <<: *go-dev-environment
      POSTGRES_HOST: postgres-classifier
      POSTGRES_PORT: 5432
      POSTGRES_USER: "${POSTGRES_CLASSIFIER_USER:-postgres}"
      POSTGRES_PASSWORD: "${POSTGRES_CLASSIFIER_PASSWORD:-postgres}"
      POSTGRES_DB: "${POSTGRES_CLASSIFIER_DB:-classifier}"
      POSTGRES_SSLMODE: disable
      ELASTICSEARCH_URL: http://elasticsearch:9200
      ES_URL: http://elasticsearch:9200
      REDIS_URL: redis:6379
      REDIS_PASSWORD: "${REDIS_PASSWORD:-}"
      CLASSIFIER_PORT: 8070
      CLASSIFIER_ENABLED: "${CLASSIFIER_ENABLED:-true}"
      POLLING_INTERVAL: "${CLASSIFIER_POLLING_INTERVAL:-30s}"
      BATCH_SIZE: "${CLASSIFIER_BATCH_SIZE:-100}"
      CONCURRENT_WORKERS: "${CLASSIFIER_CONCURRENCY:-5}"
      PPROF_PORT: 6060
    volumes:
      - ./classifier:/app
      - ./classifier/config.yml:/app/config.yml:ro
      - ./infrastructure:/infrastructure
      - classifier_go_mod_cache:/tmp/go-mod-cache
      - classifier_go_build_cache:/tmp/go-build-cache
    command: ["sh", "-c", "go mod download && air -c .air.toml"]
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8070/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 25s

  # ------------------------------------------------------------
  # Index Manager (Dev)
  # ------------------------------------------------------------
  index-manager:
    <<: *go-dev-defaults
    build:
      context: ./index-manager
      dockerfile: Dockerfile.dev
      args:
        UID: "${UID:-1000}"
        GID: "${GID:-1000}"
    ports:
      - "${INDEX_MANAGER_PORT:-8090}:8090"
    depends_on:
      postgres-index-manager:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    environment:
      <<: *go-dev-environment
      INDEX_MANAGER_PORT: 8090
      POSTGRES_INDEX_MANAGER_HOST: postgres-index-manager
      POSTGRES_INDEX_MANAGER_PORT: 5432
      POSTGRES_INDEX_MANAGER_USER: "${POSTGRES_INDEX_MANAGER_USER:-postgres}"
      POSTGRES_INDEX_MANAGER_PASSWORD: "${POSTGRES_INDEX_MANAGER_PASSWORD:-postgres}"
      POSTGRES_INDEX_MANAGER_DB: "${POSTGRES_INDEX_MANAGER_DB:-index_manager}"
      ELASTICSEARCH_URL: http://elasticsearch:9200
      CONFIG_PATH: /app/config.yml
    volumes:
      - ./index-manager:/app
      - index_manager_go_mod_cache:/tmp/go-mod-cache
      - index_manager_go_build_cache:/tmp/go-build-cache
      - ./infrastructure:/infrastructure
    command: ["sh", "-c", "go mod download && air -c .air.toml"]
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8090/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  # ------------------------------------------------------------
  # Search Service (Dev)
  # ------------------------------------------------------------
  search-service:
    <<: *go-dev-defaults
    build:
      context: ./search
      dockerfile: Dockerfile.dev
      args:
        UID: "${UID:-1000}"
        GID: "${GID:-1000}"
    ports:
      - "${SEARCH_PORT:-8092}:8090"
      - "${SEARCH_PPROF_PORT:-6066}:6060"
    depends_on:
      elasticsearch:
        condition: service_healthy
    environment:
      <<: *go-dev-environment
      SEARCH_PORT: 8090
      SEARCH_DEBUG: "true"
      ELASTICSEARCH_URL: http://elasticsearch:9200
      LOG_LEVEL: debug
      LOG_FORMAT: json
      PPROF_PORT: 6060
    volumes:
      - ./search:/app
      - search_go_mod_cache:/tmp/go-mod-cache
      - search_go_build_cache:/tmp/go-build-cache
      - ./infrastructure:/infrastructure
    command: ["sh", "-c", "go mod download && air -c .air.toml"]
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ------------------------------------------------------------
  # Dashboard (Dev)
  # ------------------------------------------------------------
  dashboard:
    <<: *node-dev-defaults
    build:
      context: ./dashboard
      dockerfile: Dockerfile.dev
      args:
        UID: "${UID:-1000}"
        GID: "${GID:-1000}"
    depends_on:
      crawler:
        condition: service_healthy
      source-manager:
        condition: service_healthy
      publisher-api:
        condition: service_healthy
      classifier:
        condition: service_healthy
      auth:
        condition: service_healthy
      index-manager:
        condition: service_started
    ports:
      - "${DASHBOARD_PORT:-3002}:3002"
    environment:
      <<: *node-dev-environment
      CRAWLER_API_URL: http://crawler:8080
      SOURCES_API_URL: http://source-manager:8050
      PUBLISHER_API_URL: http://publisher-api:8070
      CLASSIFIER_API_URL: http://classifier:8070
      AUTH_API_URL: http://auth:8040
      INDEX_MANAGER_API_URL: http://index-manager:8090
    volumes:
      - ./dashboard:/app
      - dashboard_node_modules:/app/node_modules
      - dashboard_npm_cache:/tmp/npm-cache
    command: ["sh", "-c", "npm install && npm run dev -- --host 0.0.0.0"]
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3002/dashboard/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s

  # ------------------------------------------------------------
  # Search Frontend (Dev)
  # ------------------------------------------------------------
  search-frontend:
    <<: *node-dev-defaults
    build:
      context: ./search-frontend
      dockerfile: Dockerfile.dev
      args:
        UID: "${UID:-1000}"
        GID: "${GID:-1000}"
    ports:
      - "${SEARCH_FRONTEND_PORT:-3003}:3003"
    depends_on:
      search-service:
        condition: service_healthy
    environment:
      <<: *node-dev-environment
      SEARCH_API_URL: http://search-service:8090
    volumes:
      - ./search-frontend:/app
      - search_frontend_node_modules:/app/node_modules
      - search_frontend_npm_cache:/tmp/npm-cache
    command: ["sh", "-c", "npm install && npm run dev -- --host 0.0.0.0"]

  # ------------------------------------------------------------
  # Auth (Dev)
  # ------------------------------------------------------------
  auth:
    <<: *go-dev-defaults
    build:
      context: .
      dockerfile: ./auth/Dockerfile.dev
      args:
        UID: "${UID:-1000}"
        GID: "${GID:-1000}"
    ports:
      - "${AUTH_PORT:-8040}:8040"
      - "${AUTH_PPROF_PORT:-6065}:6060"
    environment:
      <<: *go-dev-environment
      AUTH_USERNAME: "${AUTH_USERNAME:-admin}"
      AUTH_PASSWORD: "${AUTH_PASSWORD:-admin}"
      AUTH_JWT_SECRET: "${AUTH_JWT_SECRET:-}"
      AUTH_PORT: 8040
      PPROF_PORT: 6060
    volumes:
      - ./auth:/app
      - ./infrastructure:/infrastructure:ro
      - auth_go_mod_cache:/tmp/go-mod-cache
      - auth_go_build_cache:/tmp/go-build-cache
    command: ["sh", "-c", "go mod download && go run main.go"]
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8040/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ------------------------------------------------------------
  # Publisher API (Dev)
  # ------------------------------------------------------------
  publisher-api:
    <<: *go-dev-defaults
    build:
      context: ./publisher
      dockerfile: Dockerfile.dev
      args:
        UID: "${UID:-1000}"
        GID: "${GID:-1000}"
    ports:
      - "${PUBLISHER_PORT:-8070}:8070"
      - "${PUBLISHER_API_PPROF_PORT:-6063}:6060"
    depends_on:
      postgres-publisher:
        condition: service_healthy
    environment:
      <<: *go-dev-environment
      POSTGRES_PUBLISHER_HOST: postgres-publisher
      POSTGRES_PUBLISHER_PORT: 5432
      POSTGRES_PUBLISHER_USER: "${POSTGRES_PUBLISHER_USER:-postgres}"
      POSTGRES_PUBLISHER_PASSWORD: "${POSTGRES_PUBLISHER_PASSWORD:-postgres}"
      POSTGRES_PUBLISHER_DB: "${POSTGRES_PUBLISHER_DB:-publisher}"
      POSTGRES_PUBLISHER_SSLMODE: disable
      PUBLISHER_PORT: 8070
      REDIS_ADDR: "${REDIS_ADDR:-redis:6379}"
      REDIS_PASSWORD: "${REDIS_PASSWORD:-}"
      GIN_MODE: debug
      PPROF_PORT: 6060
    volumes:
      - ./publisher:/app
      - publisher_go_mod_cache:/tmp/go-mod-cache
      - publisher_go_build_cache:/tmp/go-build-cache
      - ./infrastructure:/infrastructure
    command: ["sh", "-c", "go mod download && air -c .air.api.toml"]
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8070/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 25s

  # ------------------------------------------------------------
  # Publisher Router (Dev)
  # ------------------------------------------------------------
  publisher-router:
    <<: *go-dev-defaults
    build:
      context: ./publisher
      dockerfile: Dockerfile.dev
      args:
        UID: "${UID:-1000}"
        GID: "${GID:-1000}"
    ports:
      - "${PUBLISHER_ROUTER_PPROF_PORT:-6064}:6060"
    depends_on:
      postgres-publisher:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      <<: *go-dev-environment
      POSTGRES_PUBLISHER_HOST: postgres-publisher
      POSTGRES_PUBLISHER_PORT: 5432
      POSTGRES_PUBLISHER_USER: "${POSTGRES_PUBLISHER_USER:-postgres}"
      POSTGRES_PUBLISHER_PASSWORD: "${POSTGRES_PUBLISHER_PASSWORD:-postgres}"
      POSTGRES_PUBLISHER_DB: "${POSTGRES_PUBLISHER_DB:-publisher}"
      POSTGRES_PUBLISHER_SSLMODE: disable
      ELASTICSEARCH_URL: http://elasticsearch:9200
      REDIS_ADDR: redis:6379
      REDIS_PASSWORD: "${REDIS_PASSWORD:-}"
      PUBLISHER_ROUTER_CHECK_INTERVAL: "${PUBLISHER_ROUTER_CHECK_INTERVAL:-5m}"
      PUBLISHER_ROUTER_BATCH_SIZE: "${PUBLISHER_ROUTER_BATCH_SIZE:-100}"
      PPROF_PORT: 6060
    volumes:
      - ./publisher:/app
      - publisher_go_mod_cache:/tmp/go-mod-cache
      - publisher_go_build_cache:/tmp/go-build-cache
      - ./infrastructure:/infrastructure
    command: ["sh", "-c", "go mod download && air -c .air.router.toml"]

  # ------------------------------------------------------------
  # Pyroscope (Continuous Profiling)
  # ------------------------------------------------------------
  pyroscope:
    image: grafana/pyroscope:latest
    ports:
      - "${PYROSCOPE_PORT:-4040}:4040"
    environment:
      PYROSCOPE_LOG_LEVEL: "${PYROSCOPE_LOG_LEVEL:-debug}"
      PYROSCOPE_STORAGE_PATH: /var/lib/pyroscope
      PYROSCOPE_BADGER_LOG_LEVEL: error
    volumes:
      - pyroscope_data:/var/lib/pyroscope
    networks:
      - north-cloud-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:4040/ready"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # ------------------------------------------------------------
  # Nginx Reverse Proxy (Dev)
  # ------------------------------------------------------------
  nginx:
    restart: unless-stopped
    networks:
      - north-cloud-network
    image: nginx:alpine
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
    volumes:
      - ./infrastructure/nginx/nginx.dev.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      source-manager:
        condition: service_healthy
      dashboard:
        condition: service_healthy
      publisher-api:
        condition: service_healthy
      auth:
        condition: service_healthy
      crawler:
        condition: service_healthy
      search-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ------------------------------------------------------------
  # Logging Infrastructure (Dev)
  # ------------------------------------------------------------

  loki:
    volumes:
      - ./infrastructure/loki/loki-config.dev.yml:/etc/loki/config.yml:ro
      - loki_data:/loki

  promtail:
    environment:
      LOG_LEVEL: debug

  grafana:
    environment:
      GF_AUTH_ANONYMOUS_ENABLED: "true"  # Easy access in dev
      GF_LOG_LEVEL: debug

# ============================================================
# Dev Cache Volumes
# ============================================================
volumes:
  go_modules_cache:
  crawler_go_mod_cache:
  crawler_go_build_cache:
  source_manager_go_mod_cache:
  source_manager_go_build_cache:
  publisher_go_mod_cache:
  publisher_go_build_cache:
  classifier_go_mod_cache:
  classifier_go_build_cache:
  index_manager_go_mod_cache:
  index_manager_go_build_cache:
  search_go_mod_cache:
  search_go_build_cache:
  dashboard_npm_cache:
  dashboard_node_modules:
  search_frontend_npm_cache:
  search_frontend_node_modules:
  auth_go_mod_cache:
  auth_go_build_cache:
  mcp_index_manager_go_mod_cache:
  mcp_index_manager_go_build_cache:
  pyroscope_data: