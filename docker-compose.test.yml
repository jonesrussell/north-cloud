# Test-specific overrides for pipeline integration tests.
# Usage: docker compose -f docker-compose.base.yml -f docker-compose.test.yml up -d
#
# Extends the base compose (postgres instances, elasticsearch, redis, minio,
# auth, ML sidecars, nc-http-proxy) with pipeline services built from
# production Dockerfiles.

# ============================================================
# Services
# ============================================================

services:

  # ------------------------------------------------------------
  # Infrastructure port overrides for test harness access
  # ------------------------------------------------------------

  elasticsearch:
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch_test_data:/usr/share/elasticsearch/data
      - ./infrastructure/elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro

  redis:
    ports:
      - "6379:6379"

  # ------------------------------------------------------------
  # Auth (Test) - override credentials for deterministic tests
  # ------------------------------------------------------------
  auth:
    environment:
      AUTH_USERNAME: admin
      AUTH_PASSWORD: testpass123
      AUTH_JWT_SECRET: test-jwt-secret-for-integration-tests
      AUTH_PORT: 8040
      APP_DEBUG: "false"
    ports:
      - "8040:8040"

  # ------------------------------------------------------------
  # nc-http-proxy (Test) - replay mode for deterministic crawls
  # ------------------------------------------------------------
  nc-http-proxy:
    environment:
      PROXY_MODE: replay

  # ------------------------------------------------------------
  # Source Manager (Test)
  # ------------------------------------------------------------
  source-manager:
    build:
      context: .
      dockerfile: ./source-manager/Dockerfile
    networks:
      - north-cloud-network
    depends_on:
      postgres-source-manager:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      APP_DEBUG: "false"
      APP_ENV: test
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 8050
      DB_HOST: postgres-source-manager
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: source_manager
      DB_SSLMODE: disable
      AUTH_JWT_SECRET: test-jwt-secret-for-integration-tests
      REDIS_EVENTS_ENABLED: "false"
      REDIS_ADDRESS: redis:6379
    ports:
      - "8050:8050"
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8050/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  # ------------------------------------------------------------
  # Crawler (Test)
  # ------------------------------------------------------------
  crawler:
    build:
      context: .
      dockerfile: ./crawler/Dockerfile
    networks:
      - north-cloud-network
    depends_on:
      postgres-crawler:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_healthy
      source-manager:
        condition: service_healthy
      nc-http-proxy:
        condition: service_healthy
    environment:
      APP_DEBUG: "false"
      APP_ENV: test
      POSTGRES_CRAWLER_HOST: postgres-crawler
      POSTGRES_CRAWLER_PORT: 5432
      POSTGRES_CRAWLER_USER: postgres
      POSTGRES_CRAWLER_PASSWORD: postgres
      POSTGRES_CRAWLER_DB: crawler
      POSTGRES_CRAWLER_SSLMODE: disable
      ELASTICSEARCH_ADDRESSES: http://elasticsearch:9200
      CRAWLER_SERVER_ADDRESS: ":8060"
      CRAWLER_SOURCES_API_URL: http://source-manager:8050/api/v1/sources
      SOURCE_MANAGER_URL: http://source-manager:8050
      CRAWLER_MINIO_ENABLED: "true"
      CRAWLER_MINIO_ENDPOINT: minio:9000
      CRAWLER_MINIO_ACCESS_KEY: minioadmin
      CRAWLER_MINIO_SECRET_KEY: changeme123
      CRAWLER_MINIO_BUCKET: html-archives
      CRAWLER_MINIO_METADATA_BUCKET: crawler-metadata
      CRAWLER_MINIO_USE_SSL: "false"
      CRAWLER_SAVE_DISCOVERED_LINKS: "false"
      AUTH_JWT_SECRET: test-jwt-secret-for-integration-tests
      REDIS_ADDRESS: redis:6379
      # Route all HTTP through the replay proxy
      HTTP_PROXY: http://nc-http-proxy:8055
      HTTPS_PROXY: http://nc-http-proxy:8055
      # Job Logs
      JOB_LOGS_ENABLED: "true"
      JOB_LOGS_BUFFER_SIZE: 100
      JOB_LOGS_SSE_ENABLED: "false"
      JOB_LOGS_ARCHIVE_ENABLED: "false"
      JOB_LOGS_REDIS_ENABLED: "false"
      REDIS_EVENTS_ENABLED: "false"
    ports:
      - "8060:8060"
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8060/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s

  # ------------------------------------------------------------
  # Classifier (Test)
  # ------------------------------------------------------------
  classifier:
    build:
      context: .
      dockerfile: ./classifier/Dockerfile
    networks:
      - north-cloud-network
    depends_on:
      postgres-classifier:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      redis:
        condition: service_healthy
      crime-ml:
        condition: service_healthy
      mining-ml:
        condition: service_healthy
      coforge-ml:
        condition: service_healthy
      entertainment-ml:
        condition: service_healthy
      anishinaabe-ml:
        condition: service_healthy
    environment:
      APP_DEBUG: "false"
      APP_ENV: test
      POSTGRES_HOST: postgres-classifier
      POSTGRES_PORT: 5432
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: classifier
      POSTGRES_SSLMODE: disable
      ELASTICSEARCH_URL: http://elasticsearch:9200
      ES_URL: http://elasticsearch:9200
      REDIS_URL: redis:6379
      REDIS_PASSWORD: ""
      CLASSIFIER_PORT: 8070
      CLASSIFIER_ENABLED: "true"
      POLLING_INTERVAL: 10s
      BATCH_SIZE: 50
      CONCURRENT_WORKERS: 2
      AUTH_JWT_SECRET: test-jwt-secret-for-integration-tests
      CRIME_ENABLED: "true"
      CRIME_ML_SERVICE_URL: http://crime-ml:8076
      MINING_ENABLED: "true"
      MINING_ML_SERVICE_URL: http://mining-ml:8077
      COFORGE_ENABLED: "true"
      COFORGE_ML_SERVICE_URL: http://coforge-ml:8078
      ENTERTAINMENT_ENABLED: "true"
      ENTERTAINMENT_ML_SERVICE_URL: http://entertainment-ml:8079
      ANISHINAABE_ENABLED: "false"
      ANISHINAABE_ML_SERVICE_URL: http://anishinaabe-ml:8080
    ports:
      - "8071:8070"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8070/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  # ------------------------------------------------------------
  # Publisher (Test)
  # ------------------------------------------------------------
  publisher:
    build:
      context: .
      dockerfile: ./publisher/Dockerfile
    command: ["/app/publisher", "both"]
    networks:
      - north-cloud-network
    depends_on:
      postgres-publisher:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      APP_DEBUG: "false"
      APP_ENV: test
      POSTGRES_PUBLISHER_HOST: postgres-publisher
      POSTGRES_PUBLISHER_PORT: 5432
      POSTGRES_PUBLISHER_USER: postgres
      POSTGRES_PUBLISHER_PASSWORD: postgres
      POSTGRES_PUBLISHER_DB: publisher
      POSTGRES_PUBLISHER_SSLMODE: disable
      PUBLISHER_PORT: 8070
      ES_URL: http://elasticsearch:9200
      REDIS_URL: redis:6379
      REDIS_PASSWORD: ""
      PUBLISHER_ROUTER_CHECK_INTERVAL: 10s
      PUBLISHER_ROUTER_BATCH_SIZE: 100
      AUTH_JWT_SECRET: test-jwt-secret-for-integration-tests
      GIN_MODE: release
    ports:
      - "8070:8070"
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8070/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s

  # ------------------------------------------------------------
  # Index Manager (Test)
  # ------------------------------------------------------------
  index-manager:
    build:
      context: .
      dockerfile: ./index-manager/Dockerfile
    networks:
      - north-cloud-network
    depends_on:
      postgres-index-manager:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    environment:
      APP_DEBUG: "false"
      APP_ENV: test
      INDEX_MANAGER_PORT: 8090
      POSTGRES_INDEX_MANAGER_HOST: postgres-index-manager
      POSTGRES_INDEX_MANAGER_PORT: 5432
      POSTGRES_INDEX_MANAGER_USER: postgres
      POSTGRES_INDEX_MANAGER_PASSWORD: postgres
      POSTGRES_INDEX_MANAGER_DB: index_manager
      ELASTICSEARCH_URL: http://elasticsearch:9200
      CONFIG_PATH: /root/config.yml
      AUTH_JWT_SECRET: test-jwt-secret-for-integration-tests
    ports:
      - "8090:8090"
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8090/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s

# ============================================================
# Volumes
# ============================================================

volumes:
  elasticsearch_test_data:
