# docker-compose.test.yml — Integration test overlay
#
# Usage:
#   docker compose -f docker-compose.base.yml -f docker-compose.test.yml up -d
#   go test ./tests/integration/pipeline/ -v -timeout 10m
#   docker compose -f docker-compose.base.yml -f docker-compose.test.yml down -v
#
# Differences from dev:
#   - No source volume mounts (uses built images)
#   - No hot reload
#   - Deterministic ports (no env var overrides)
#   - nc-http-proxy forced to replay mode
#   - Ephemeral volumes (removed on down -v)
#   - Postgres containers auto-run migrations on first init

services:

  # ------------------------------------------------------------
  # PostgreSQL — mount migration init script for auto-schema
  # ------------------------------------------------------------
  postgres-source-manager:
    volumes:
      - ./infrastructure/postgres/run-migrations.sh:/docker-entrypoint-initdb.d/run-migrations.sh:ro

  postgres-crawler:
    volumes:
      - ./infrastructure/postgres/run-migrations.sh:/docker-entrypoint-initdb.d/run-migrations.sh:ro

  postgres-classifier:
    volumes:
      - ./infrastructure/postgres/run-migrations.sh:/docker-entrypoint-initdb.d/run-migrations.sh:ro

  postgres-index-manager:
    volumes:
      - ./infrastructure/postgres/run-migrations.sh:/docker-entrypoint-initdb.d/run-migrations.sh:ro

  postgres-publisher:
    volumes:
      - ./infrastructure/postgres/run-migrations.sh:/docker-entrypoint-initdb.d/run-migrations.sh:ro

  # ------------------------------------------------------------
  # Elasticsearch — override production host path with named volume
  # ------------------------------------------------------------
  elasticsearch:
    volumes:
      - es_test_data:/usr/share/elasticsearch/data

  # ------------------------------------------------------------
  # Auth
  # ------------------------------------------------------------
  auth:
    build:
      context: .
      dockerfile: ./auth/Dockerfile
    networks:
      - north-cloud-network
    environment:
      AUTH_USERNAME: testuser
      AUTH_PASSWORD: testpass
      AUTH_JWT_SECRET: test-jwt-secret-for-integration-tests
      AUTH_PORT: "8040"
      APP_DEBUG: "false"
    depends_on:
      - redis
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8040/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s

  # ------------------------------------------------------------
  # Source Manager
  # ------------------------------------------------------------
  source-manager:
    build:
      context: .
      dockerfile: ./source-manager/Dockerfile
    networks:
      - north-cloud-network
    environment:
      DB_HOST: postgres-source-manager
      DB_PORT: "5432"
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: source_manager
      DB_SSLMODE: disable
      AUTH_JWT_SECRET: test-jwt-secret-for-integration-tests
      APP_DEBUG: "false"
    depends_on:
      postgres-source-manager:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8050/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  # ------------------------------------------------------------
  # Index Manager
  # ------------------------------------------------------------
  index-manager:
    build:
      context: .
      dockerfile: ./index-manager/Dockerfile
    networks:
      - north-cloud-network
    environment:
      POSTGRES_INDEX_MANAGER_HOST: postgres-index-manager
      POSTGRES_INDEX_MANAGER_PORT: "5432"
      POSTGRES_INDEX_MANAGER_USER: postgres
      POSTGRES_INDEX_MANAGER_PASSWORD: postgres
      POSTGRES_INDEX_MANAGER_DB: index_manager
      POSTGRES_INDEX_MANAGER_SSLMODE: disable
      ELASTICSEARCH_URL: http://elasticsearch:9200
      AUTH_JWT_SECRET: test-jwt-secret-for-integration-tests
      APP_DEBUG: "false"
    depends_on:
      postgres-index-manager:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8090/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  # ------------------------------------------------------------
  # Crawler
  # ------------------------------------------------------------
  crawler:
    build:
      context: .
      dockerfile: ./crawler/Dockerfile
    networks:
      - north-cloud-network
    environment:
      POSTGRES_CRAWLER_HOST: postgres-crawler
      POSTGRES_CRAWLER_PORT: "5432"
      POSTGRES_CRAWLER_USER: postgres
      POSTGRES_CRAWLER_PASSWORD: postgres
      POSTGRES_CRAWLER_DB: crawler
      POSTGRES_CRAWLER_SSLMODE: disable
      ELASTICSEARCH_ADDRESSES: http://elasticsearch:9200
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: changeme123
      MINIO_USE_SSL: "false"
      MINIO_BUCKET: html-archives
      SOURCE_MANAGER_URL: http://source-manager:8050
      HTTP_PROXY: http://nc-http-proxy:8055
      AUTH_JWT_SECRET: test-jwt-secret-for-integration-tests
      APP_DEBUG: "false"
    depends_on:
      postgres-crawler:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_healthy
      source-manager:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8060/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  # ------------------------------------------------------------
  # Classifier
  # ------------------------------------------------------------
  classifier:
    build:
      context: .
      dockerfile: ./classifier/Dockerfile
    networks:
      - north-cloud-network
    environment:
      POSTGRES_HOST: postgres-classifier
      POSTGRES_PORT: "5432"
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: classifier
      POSTGRES_SSLMODE: disable
      ELASTICSEARCH_URL: http://elasticsearch:9200
      CLASSIFIER_POLL_INTERVAL: "5s"
      AUTH_JWT_SECRET: test-jwt-secret-for-integration-tests
      APP_DEBUG: "false"
    depends_on:
      postgres-classifier:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8070/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  # ------------------------------------------------------------
  # Publisher
  # ------------------------------------------------------------
  publisher:
    build:
      context: .
      dockerfile: ./publisher/Dockerfile
    networks:
      - north-cloud-network
    environment:
      POSTGRES_PUBLISHER_HOST: postgres-publisher
      POSTGRES_PUBLISHER_PORT: "5432"
      POSTGRES_PUBLISHER_USER: postgres
      POSTGRES_PUBLISHER_PASSWORD: postgres
      POSTGRES_PUBLISHER_DB: publisher
      POSTGRES_PUBLISHER_SSLMODE: disable
      ES_URL: http://elasticsearch:9200
      REDIS_URL: redis:6379
      PUBLISHER_ROUTER_CHECK_INTERVAL: "10s"
      AUTH_JWT_SECRET: test-jwt-secret-for-integration-tests
      APP_DEBUG: "false"
    depends_on:
      postgres-publisher:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8070/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  # ------------------------------------------------------------
  # nc-http-proxy (forced replay mode)
  # ------------------------------------------------------------
  nc-http-proxy:
    environment:
      PROXY_MODE: replay

volumes:
  es_test_data:

networks:
  north-cloud-network:
    driver: bridge
