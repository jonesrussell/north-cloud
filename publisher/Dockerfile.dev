FROM golang:1.25-alpine

WORKDIR /app

# Install build dependencies and tools
RUN apk add --no-cache git curl wget

# Install air for hot reloading
# For Go 1.25+, use go install
RUN go install github.com/air-verse/air@latest

# Create non-root user for development
RUN addgroup -g 1000 appuser && \
    adduser -D -u 1000 -G appuser appuser

# Only copy go.mod and go.sum to download dependencies
# Source code will be mounted as a volume in development
COPY go.mod go.sum ./
RUN go mod download

# Note: Source code is NOT copied here - it will be mounted as a volume
# This allows for live code editing and hot reloading in development

# Set ownership for app directory (will be overridden by volume mount, but good practice)
RUN chown -R appuser:appuser /app

# Set PATH to include Go binaries (needed for non-root user)
ENV PATH=$PATH:/usr/local/go/bin:/go/bin

# Switch to non-root user
USER appuser

EXPOSE 8080

# Default command: build and run from mounted source
# The source code will be available via volume mount
# Use -mod=mod to ignore vendor directory if present
CMD ["sh", "-c", "go build -mod=mod -o /tmp/integration ./main.go && /tmp/integration -config config.yml"]
