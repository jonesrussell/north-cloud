FROM node:25-slim

ARG UID=1000
ARG GID=1000

WORKDIR /app

# Install minimal dev tools
RUN apt-get update && \
    apt-get install -y --no-install-recommends git wget && \
    rm -rf /var/lib/apt/lists/*

# Create matching user (handle existing UID/GID)
RUN if getent group ${GID} >/dev/null; then \
      existing_group=$(getent group ${GID} | cut -d: -f1); \
    else \
      groupadd -g ${GID} appuser && existing_group=appuser; \
    fi && \
    if getent passwd ${UID} >/dev/null; then \
      echo "Using existing user with UID ${UID}"; \
    else \
      useradd -u ${UID} -g ${existing_group} -m appuser; \
    fi

# Writable npm cache
RUN mkdir -p /tmp/npm-cache && \
    chmod 1777 /tmp/npm-cache

# Pre-create node_modules so host bind mount doesn't break permissions
RUN mkdir -p /app/node_modules && \
    chown -R ${UID}:${GID} /app

# Copy package files (source will be bind-mounted)
COPY --chown=${UID}:${GID} package*.json ./

EXPOSE 3002

# Use npm cache in /tmp
ENV NPM_CONFIG_CACHE=/tmp/npm-cache

# Default dev command
CMD ["sh", "-c", "npm install && npm run dev -- --host 0.0.0.0"]
