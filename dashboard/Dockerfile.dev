FROM node:25-alpine

ARG UID=1000
ARG GID=1000

WORKDIR /app

# Install minimal dev tools
RUN apk add --no-cache git

# Create matching user
RUN addgroup -g ${GID} appuser && \
    adduser -D -u ${UID} -G appuser appuser

# Writable npm cache
RUN mkdir -p /tmp/npm-cache && \
    chmod 1777 /tmp/npm-cache

# Pre-create node_modules so host bind mount doesn't break permissions
RUN mkdir -p /app/node_modules && \
    chown -R ${UID}:${GID} /app

# Copy package files (source will be bind-mounted)
COPY --chown=${UID}:${GID} package*.json ./

EXPOSE 3002

# Use npm cache in /tmp
ENV NPM_CONFIG_CACHE=/tmp/npm-cache

# Default dev command
CMD ["sh", "-c", "npm install && npm run dev -- --host 0.0.0.0"]
