# Click Tracker

Privacy-respecting, HMAC-verified click tracking for North Cloud search results.

## Overview

Click Tracker intercepts outbound clicks from the North Cloud search service, records behavioral analytics, and redirects the user to their destination. It sits between the search results page and the destination URL, acting as a lightweight redirect service with a built-in event pipeline.

When search result URLs are rendered, the search service wraps each destination URL in a signed `/click` redirect URL. The user's browser follows that URL, click-tracker validates the HMAC signature, records the event (query ID, result position, page number, destination hash), and issues a `302 Found` to the real article URL.

The service fits into the broader platform pipeline as a downstream consumer of search results:

```
Search Service  →  click-tracker  →  Destination URL
                        ↓
               PostgreSQL (click_events)
```

## Features

- HMAC-SHA256 signed redirect URLs — forged or replayed links are rejected
- Timestamp expiry window (configurable, default 24 hours) prevents stale link replay
- Bot detection middleware — 24 known crawler User-Agent patterns identified and excluded from event storage while still receiving the redirect
- Per-IP rate limiting with in-memory sliding window, configurable maximum clicks per interval
- Channel-based event buffer with configurable capacity (default 1,000 events)
- Batch PostgreSQL inserts — events are flushed in configurable chunks (default threshold 500, interval 1 second) to reduce write pressure
- Destination URLs and User-Agent strings are hashed (SHA-256) before storage — the raw URL and UA are never persisted
- Partitioned `click_events` table (`PARTITION BY RANGE (clicked_at)`) for efficient time-based querying and data management
- JSON structured logging via `infrastructure/logger`
- Profiling endpoint via `infrastructure/profiling` (pprof)
- Memory health endpoint at `/health/memory`
- Hot reload in development via Air

## Quick Start

### Docker (Recommended)

The service is included in the North Cloud `docker-compose.base.yml`. Start it alongside its database dependency:

```bash
# From the repo root
docker compose -f docker-compose.base.yml -f docker-compose.dev.yml up -d click-tracker

# Verify it is running
curl http://localhost:8093/health
```

The container exposes port `8093` by default (configurable via `CLICK_TRACKER_PORT`).

### Local Development

**Prerequisites**: Go 1.26+, PostgreSQL, `golangci-lint`, `air` (optional, for hot reload)

```bash
cd click-tracker

# Copy and edit configuration
cp config.yml.example config.yml
# Set hmac_secret, database credentials, etc.

# Run database migrations
go run cmd/migrate/main.go up

# Run the service
go run main.go

# Or with hot reload
air
```

## API Reference

All endpoints that require authentication use JWT tokens shared with the rest of the platform (see the `auth` service). The `/click` and `/health*` endpoints are public.

| Method | Path | Auth | Description |
|--------|------|------|-------------|
| GET | `/click` | None | Validate signature, record event, redirect to destination |
| GET | `/health` | None | Service liveness check |
| GET | `/health/memory` | None | Memory usage statistics |

### GET /click

Validates an HMAC-signed click URL produced by the search service, records the event, and redirects the client.

**Query Parameters**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `q` | string | Yes | Query ID (identifies the search session) |
| `r` | string | Yes | Result ID (Elasticsearch document ID) |
| `p` | int | Yes | Result position within the page (1-indexed) |
| `pg` | int | No | Page number (default: 1) |
| `t` | int64 | Yes | Unix timestamp when the URL was generated |
| `u` | string | Yes | URL-encoded destination URL |
| `sig` | string | Yes | HMAC-SHA256 signature (first 12 hex chars) |

**Responses**

| Status | Condition |
|--------|-----------|
| `302 Found` | Valid signature and timestamp — redirects to `u` |
| `400 Bad Request` | Missing or unparseable required parameters |
| `403 Forbidden` | Invalid HMAC signature |
| `410 Gone` | URL has exceeded the configured `max_timestamp_age` |
| `429 Too Many Requests` | Per-IP rate limit exceeded |

**Example (generated by the search service)**

```
GET /click?q=q_a1b2c3d4&r=es-doc-id-abc&p=3&pg=1&t=1708300000&u=https%3A%2F%2Fexample.com%2Farticle&sig=a1b2c3d4e5f6
```

### GET /health

```json
{
  "status": "healthy",
  "version": "0.1.0",
  "timestamp": "2026-02-20T12:00:00Z"
}
```

## Configuration

Configuration is loaded from `config.yml` (path resolved via `infrastructure/config`). All fields can be overridden with environment variables.

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `CLICK_TRACKER_PORT` | `8093` | HTTP listen port |
| `CLICK_TRACKER_SECRET` | — | **Required.** HMAC-SHA256 signing secret. Must match the secret configured in the search service. |
| `APP_DEBUG` | `false` | Enable debug mode and verbose Gin logging |
| `POSTGRES_CLICK_TRACKER_HOST` | `localhost` | PostgreSQL host |
| `POSTGRES_CLICK_TRACKER_PORT` | `5432` | PostgreSQL port |
| `POSTGRES_CLICK_TRACKER_USER` | `postgres` | PostgreSQL user |
| `POSTGRES_CLICK_TRACKER_PASSWORD` | — | PostgreSQL password |
| `POSTGRES_CLICK_TRACKER_DB` | `click_tracker` | PostgreSQL database name |
| `POSTGRES_CLICK_TRACKER_SSLMODE` | `disable` | PostgreSQL SSL mode |
| `LOG_LEVEL` | `info` | Log level: `debug`, `info`, `warn`, `error` |
| `LOG_FORMAT` | `json` | Log format: `json` or `console` |

### config.yml Reference

```yaml
service:
  name: "click-tracker"
  version: "0.1.0"
  port: 8093
  debug: false
  hmac_secret: "generate-strong-secret-here"   # Required
  signature_length: 12                          # Hex chars kept from HMAC digest
  max_timestamp_age: "24h"                      # Reject links older than this
  buffer_size: 1000                             # In-memory event channel capacity
  flush_interval: "1s"                          # Flush to DB at least this often
  flush_threshold: 500                          # Flush when batch reaches this size

database:
  host: "postgres-click-tracker"
  port: 5432
  user: "postgres"
  password: "postgres"
  database: "click_tracker"
  sslmode: "disable"

rate_limit:
  max_clicks_per_minute: 10   # Maximum requests per IP per window
  window_seconds: 60          # Sliding window size in seconds

logging:
  level: "info"     # debug, info, warn, error
  format: "json"    # json or console
```

## Architecture

```
click-tracker/
├── main.go                        # Entry point; wires config, DB, buffer, server
├── cmd/
│   └── migrate/
│       └── main.go                # Database migration runner (up/down)
├── config.yml.example             # Configuration template
├── migrations/
│   ├── 001_create_click_events.up.sql   # Creates partitioned click_events table
│   └── 001_create_click_events.down.sql
└── internal/
    ├── api/
    │   ├── server.go              # Gin server construction via infragin builder
    │   └── routes.go              # Route registration; applies bot filter + rate limiter
    ├── config/
    │   └── config.go              # Config struct, defaults, validation
    ├── domain/
    │   └── click_event.go         # ClickEvent value type
    ├── handler/
    │   ├── click.go               # HandleClick: parse → verify → expiry → buffer
    │   └── health.go              # Health check handler
    ├── middleware/
    │   ├── botfilter.go           # Sets is_bot=true for 24 known crawler UAs
    │   └── ratelimit.go           # In-memory per-IP sliding window rate limiter
    └── storage/
        └── postgres.go            # Buffer (channel) + Store (batch insert to PG)
```

### Key Data Flow

1. Request arrives at `GET /click`.
2. `BotFilter` middleware inspects the User-Agent and sets `is_bot=true` for known crawlers.
3. `RateLimiter` middleware enforces per-IP request counts; returns `429` when exceeded.
4. `ClickHandler.HandleClick` parses query parameters, verifies the HMAC signature, checks timestamp age.
5. If the request is not from a bot, a `ClickEvent` is sent to the in-memory `Buffer` channel (non-blocking; events are dropped and warned when the buffer is full).
6. The handler issues a `302` redirect to the destination URL.
7. In the background, `Store.flushLoop` drains the buffer into PostgreSQL in batches via a single `INSERT ... VALUES (...)` statement with up to 50 rows.

### Database Schema

```sql
CREATE TABLE click_events (
    id               BIGSERIAL PRIMARY KEY,
    query_id         VARCHAR(32)  NOT NULL,
    result_id        VARCHAR(128) NOT NULL,
    position         SMALLINT     NOT NULL,
    page             SMALLINT     NOT NULL DEFAULT 1,
    destination_hash VARCHAR(64)  NOT NULL,    -- SHA-256 of destination URL
    session_id       VARCHAR(32),
    user_agent_hash  VARCHAR(12),              -- First 12 hex chars of SHA-256(UA)
    generated_at     TIMESTAMPTZ  NOT NULL,
    clicked_at       TIMESTAMPTZ  NOT NULL DEFAULT NOW(),
    created_at       TIMESTAMPTZ  NOT NULL DEFAULT NOW()
) PARTITION BY RANGE (clicked_at);
```

Indexes exist on `query_id`, `result_id`, `destination_hash`, and `clicked_at`.

## Development

### Running Tests

```bash
cd click-tracker

# All tests
go test ./...

# Unit tests only
task test:unit

# With coverage report
task test:coverage

# With race detector
task test:race

# All tests (via Taskfile)
task test
```

### Linting

```bash
# Lint (matches CI)
task lint

# Lint with empty cache (exact CI parity)
task lint:no-cache
```

### Building

```bash
# Binary
task build
# Output: bin/click-tracker

# Docker image
task docker:build

# Development image (with Air hot reload)
task docker:build:dev
```

### Running Migrations

```bash
# Apply migrations
go run cmd/migrate/main.go up

# Roll back
go run cmd/migrate/main.go down
```

## Integration

### Search Service (Upstream)

The search service generates signed click URLs using the shared `infrastructure/clickurl` package. Both services must be configured with the same `CLICK_TRACKER_SECRET`.

In the search service `config.yml`:

```yaml
click_tracker:
  enabled: true
  secret: "same-secret-as-click-tracker"
  base_url: "http://click-tracker:8093"
```

When `enabled: true`, every URL in a search response is rewritten to route through `click-tracker`. When disabled, URLs point directly to the destination.

### HMAC Signature Format

The signature covers a pipe-delimited message:

```
{query_id}|{result_id}|{position}|{page}|{timestamp}|{destination_url}
```

The HMAC-SHA256 digest is truncated to the first 12 hex characters. Constant-time comparison (`hmac.Equal`) is used during verification to prevent timing attacks.
