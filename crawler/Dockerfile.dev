FROM golang:1.25-alpine

WORKDIR /app

# Install build dependencies and tools
RUN apk add --no-cache git curl wget

# Install air for hot reloading (optional)
# For Go 1.25+, use go install
RUN go install github.com/air-verse/air@latest

# Create non-root user for development
# Note: Files will be mounted from host, so no chown needed
RUN addgroup -g 1000 appuser && \
    adduser -D -u 1000 -G appuser appuser

# Create a writable Go module cache directory for non-root user
RUN mkdir -p /home/appuser/go-mod-cache && \
    chown -R appuser:appuser /home/appuser

# Set PATH to include Go binaries (needed for non-root user)
ENV PATH=$PATH:/usr/local/go/bin:/go/bin

# Set GOMODCACHE to a writable location for non-root user
ENV GOMODCACHE=/home/appuser/go-mod-cache

# Note: No files are copied here - everything will be mounted as volumes
# Dependencies will be downloaded at runtime from mounted go.mod/go.sum
# Source code will be mounted from host filesystem

# Switch to non-root user
USER appuser

# Default command: run from mounted source
# The source code will be available via volume mount
# Use -mod=mod to ignore vendor directory if present
# Can be overridden in docker-compose to use air for hot reloading
CMD ["sh", "-c", "go run -mod=mod ./main.go"]
