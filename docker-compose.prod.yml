# ============================================================
# Production Defaults (DRY)
# ============================================================

x-prod-defaults: &prod-defaults
  networks:
    - north-cloud-network
  restart: always

# ============================================================
# Application Services - Production
# ============================================================

services:

  # ------------------------------------------------------------
  # Crawler (Prod)
  # ------------------------------------------------------------
  crawler:
    <<: *prod-defaults
    build:
      context: .
      dockerfile: ./crawler/Dockerfile
      args:
        BUILD_ENV: production
    image: northcloud/crawler:latest
    depends_on:
      postgres-crawler:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      source-manager:
        condition: service_healthy
    environment:
      DB_HOST: postgres-crawler
      DB_PORT: 5432
      DB_USER: "${POSTGRES_CRAWLER_USER}"
      DB_PASSWORD: "${POSTGRES_CRAWLER_PASSWORD}"
      DB_NAME: "${POSTGRES_CRAWLER_DB:-crawler}"
      DB_SSLMODE: disable
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
      CRAWLER_SOURCES_API_URL: http://source-manager:8050/api/v1/sources
      CRAWLER_SAVE_DISCOVERED_LINKS: "${CRAWLER_SAVE_DISCOVERED_LINKS:-false}"
      APP_ENV: production
      AUTH_JWT_SECRET: "${AUTH_JWT_SECRET}"
      SERVER_SECURITY_ENABLED: "false"
      SERVER_PORT: "8080"
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ------------------------------------------------------------
  # Source Manager (Prod)
  # ------------------------------------------------------------
  source-manager:
    <<: *prod-defaults
    build:
      context: .
      dockerfile: ./source-manager/Dockerfile
      args:
        BUILD_ENV: production
    image: northcloud/source-manager:latest
    depends_on:
      postgres-source-manager:
        condition: service_healthy
    environment:
      APP_DEBUG: "false"
      APP_ENV: production
      SERVER_HOST: "${SOURCE_MANAGER_HOST:-0.0.0.0}"
      SERVER_PORT: "${SOURCE_MANAGER_PORT:-8050}"
      DB_HOST: postgres-source-manager
      DB_PORT: 5432
      DB_USER: "${POSTGRES_SOURCE_MANAGER_USER}"
      DB_PASSWORD: "${POSTGRES_SOURCE_MANAGER_PASSWORD}"
      DB_NAME: "${POSTGRES_SOURCE_MANAGER_DB:-gosources}"
      DB_SSLMODE: disable
    volumes:
      - ./source-manager/migrations:/migrations:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8050/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ------------------------------------------------------------
  # Publisher API (Prod)
  # ------------------------------------------------------------
  publisher-api:
    <<: *prod-defaults
    build:
      context: .
      dockerfile: ./publisher/Dockerfile
      args:
        BUILD_ENV: production
    image: northcloud/publisher:latest
    command: ["/app/publisher", "api"]
    depends_on:
      postgres-publisher:
        condition: service_healthy
    environment:
      POSTGRES_PUBLISHER_HOST: postgres-publisher
      POSTGRES_PUBLISHER_PORT: 5432
      POSTGRES_PUBLISHER_USER: "${POSTGRES_PUBLISHER_USER:-postgres}"
      POSTGRES_PUBLISHER_PASSWORD: "${POSTGRES_PUBLISHER_PASSWORD:-postgres}"
      POSTGRES_PUBLISHER_DB: "${POSTGRES_PUBLISHER_DB:-publisher}"
      POSTGRES_PUBLISHER_SSLMODE: disable
      PUBLISHER_PORT: 8070
      AUTH_JWT_SECRET: "${AUTH_JWT_SECRET}"
      REDIS_ADDR: redis:6379
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
      GIN_MODE: release
      APP_DEBUG: "false"
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8070/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 25s

  # ------------------------------------------------------------
  # Publisher Router (Prod)
  # ------------------------------------------------------------
  publisher-router:
    <<: *prod-defaults
    build:
      context: .
      dockerfile: ./publisher/Dockerfile
      args:
        BUILD_ENV: production
    image: northcloud/publisher:latest
    command: ["/app/publisher", "router"]
    depends_on:
      postgres-publisher:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      POSTGRES_PUBLISHER_HOST: postgres-publisher
      POSTGRES_PUBLISHER_PORT: 5432
      POSTGRES_PUBLISHER_USER: "${POSTGRES_PUBLISHER_USER:-postgres}"
      POSTGRES_PUBLISHER_PASSWORD: "${POSTGRES_PUBLISHER_PASSWORD:-postgres}"
      POSTGRES_PUBLISHER_DB: "${POSTGRES_PUBLISHER_DB:-publisher}"
      POSTGRES_PUBLISHER_SSLMODE: disable
      ELASTICSEARCH_URL: http://elasticsearch:9200
      REDIS_ADDR: redis:6379
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
      PUBLISHER_ROUTER_CHECK_INTERVAL: "${PUBLISHER_ROUTER_CHECK_INTERVAL:-5m}"
      PUBLISHER_ROUTER_BATCH_SIZE: "${PUBLISHER_ROUTER_BATCH_SIZE:-100}"
      APP_DEBUG: "false"

  # ------------------------------------------------------------
  # Classifier (Prod)
  # ------------------------------------------------------------
  classifier:
    <<: *prod-defaults
    build:
      context: .
      dockerfile: ./classifier/Dockerfile
      args:
        BUILD_ENV: production
    image: northcloud/classifier:latest
    command: ["./classifier", "httpd"]
    depends_on:
      postgres-classifier:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      POSTGRES_HOST: postgres-classifier
      POSTGRES_PORT: 5432
      POSTGRES_USER: "${POSTGRES_CLASSIFIER_USER:-postgres}"
      POSTGRES_PASSWORD: "${POSTGRES_CLASSIFIER_PASSWORD:-postgres}"
      POSTGRES_DB: "${POSTGRES_CLASSIFIER_DB:-classifier}"
      POSTGRES_SSLMODE: disable
      ELASTICSEARCH_URL: http://elasticsearch:9200
      ES_URL: http://elasticsearch:9200
      REDIS_URL: redis:6379
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
      APP_DEBUG: "false"
      APP_ENV: production
      CLASSIFIER_PORT: 8070
    volumes:
      - ./classifier/config.yml:/root/config.yml:ro
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8070/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 25s

  # ------------------------------------------------------------
  # Index Manager (Prod)
  # ------------------------------------------------------------
  index-manager:
    <<: *prod-defaults
    build:
      context: ./index-manager
      dockerfile: Dockerfile
    image: northcloud/index-manager:latest
    depends_on:
      postgres-index-manager:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    environment:
      INDEX_MANAGER_PORT: 8090
      POSTGRES_INDEX_MANAGER_HOST: postgres-index-manager
      POSTGRES_INDEX_MANAGER_PORT: 5432
      POSTGRES_INDEX_MANAGER_USER: "${POSTGRES_INDEX_MANAGER_USER}"
      POSTGRES_INDEX_MANAGER_PASSWORD: "${POSTGRES_INDEX_MANAGER_PASSWORD}"
      POSTGRES_INDEX_MANAGER_DB: "${POSTGRES_INDEX_MANAGER_DB:-index_manager}"
      ELASTICSEARCH_URL: http://elasticsearch:9200
      CONFIG_PATH: /root/config.yml
      APP_DEBUG: "false"
      APP_ENV: production
    volumes:
      - ./index-manager/config.yml:/root/config.yml:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ------------------------------------------------------------
  # Search Service (Prod)
  # ------------------------------------------------------------
  search-service:
    <<: *prod-defaults
    build:
      context: .
      dockerfile: ./search/Dockerfile
    image: northcloud/search-service:latest
    depends_on:
      elasticsearch:
        condition: service_healthy
    environment:
      APP_DEBUG: "false"
      SEARCH_PORT: 8090
      SEARCH_DEBUG: "false"
      ELASTICSEARCH_URL: http://elasticsearch:9200
      ELASTICSEARCH_USERNAME: "${ELASTICSEARCH_USERNAME:-}"
      ELASTICSEARCH_PASSWORD: "${ELASTICSEARCH_PASSWORD:-}"
      LOG_LEVEL: "${SEARCH_LOG_LEVEL:-info}"
      LOG_FORMAT: "${SEARCH_LOG_FORMAT:-json}"
      CORS_ORIGINS: "${CORS_ORIGINS:-*}"
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ------------------------------------------------------------
  # Dashboard (Prod)
  # ------------------------------------------------------------
  dashboard:
    <<: *prod-defaults
    build:
      context: ./dashboard
      dockerfile: Dockerfile
      args:
        BUILD_ENV: production
    image: northcloud/dashboard:latest
    depends_on:
      crawler:
        condition: service_started
      source-manager:
        condition: service_healthy
      publisher-api:
        condition: service_started
      classifier:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:80/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ------------------------------------------------------------
  # Nginx Reverse Proxy (Prod)
  # ------------------------------------------------------------
  nginx:
    <<: *prod-defaults
    image: nginx:alpine
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./infrastructure/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - certbot_etc:/etc/letsencrypt:ro
      - certbot_www:/var/www/certbot
    depends_on:
      dashboard:
        condition: service_healthy
      classifier:
        condition: service_started
      crawler:
        condition: service_started
      publisher-api:
        condition: service_started

  # ============================================================
  # Certbot (Prod)
  # ============================================================
  certbot:
    image: certbot/certbot
    networks:
      - north-cloud-network
    volumes:
      - certbot_etc:/etc/letsencrypt
      - certbot_www:/var/www/certbot
    entrypoint: >
      /bin/sh -c '
      trap exit TERM;
      while :; do
        if [ -d /etc/letsencrypt/live ]; then
          echo "[$$(date)] Running certificate renewal check...";
          certbot renew &&
          echo "[$$(date)] Renewal check completed. If renewed, reload nginx with: docker exec north-cloud-nginx nginx -s reload";
        fi;
        sleep 12h & wait $$$${!};
      done;
      '
    restart: always

  # ============================================================
  # Elasticsearch (Prod Overrides)
  # ============================================================
  elasticsearch:
    environment:
      xpack.security.enabled: "${ELASTICSEARCH_SECURITY_ENABLED:-false}"
      ES_JAVA_OPTS: "-Xms${ELASTICSEARCH_MIN_HEAP:-256m} -Xmx${ELASTICSEARCH_MAX_HEAP:-512m}"

  # ============================================================
  # Redis (Prod Overrides)
  # ============================================================
  redis:
    environment:
      REDIS_PASSWORD: "${REDIS_PASSWORD}"

# ============================================================
# Production Volumes
# ============================================================
volumes:
  certbot_etc:
    driver: local
  certbot_www:
    driver: local
