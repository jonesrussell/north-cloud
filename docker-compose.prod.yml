# ============================================================
# Production Defaults (DRY)
# ============================================================

x-prod-defaults: &prod-defaults
  networks:
    - north-cloud-network
  restart: always

# ============================================================
# Application Services - Production
# ============================================================

services:

  # ------------------------------------------------------------
  # Crawler (Prod)
  # ------------------------------------------------------------
  crawler:
    <<: *prod-defaults
    image: docker.io/jonesrussell/crawler:latest
    depends_on:
      postgres-crawler:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      minio:
        condition: service_healthy
      source-manager:
        condition: service_healthy
    environment:
      POSTGRES_CRAWLER_HOST: postgres-crawler
      POSTGRES_CRAWLER_PORT: 5432
      POSTGRES_CRAWLER_USER: "${POSTGRES_CRAWLER_USER:-postgres}"
      POSTGRES_CRAWLER_PASSWORD: "${POSTGRES_CRAWLER_PASSWORD:-postgres}"
      POSTGRES_CRAWLER_DB: "${POSTGRES_CRAWLER_DB:-crawler}"
      POSTGRES_CRAWLER_SSLMODE: disable
      ELASTICSEARCH_ADDRESSES: http://elasticsearch:9200
      CRAWLER_SOURCES_API_URL: http://source-manager:8050/api/v1/sources
      CRAWLER_SAVE_DISCOVERED_LINKS: "${CRAWLER_SAVE_DISCOVERED_LINKS:-false}"
      CRAWLER_MINIO_ENABLED: "${CRAWLER_MINIO_ENABLED:-false}"
      CRAWLER_MINIO_ENDPOINT: "${CRAWLER_MINIO_ENDPOINT:-minio:9000}"
      CRAWLER_MINIO_ACCESS_KEY: "${CRAWLER_MINIO_ACCESS_KEY:-}"
      CRAWLER_MINIO_SECRET_KEY: "${CRAWLER_MINIO_SECRET_KEY:-}"
      CRAWLER_MINIO_USE_SSL: "${CRAWLER_MINIO_USE_SSL:-false}"
      CRAWLER_MINIO_BUCKET: "${CRAWLER_MINIO_BUCKET:-html-archives}"
      CRAWLER_MINIO_METADATA_BUCKET: "${CRAWLER_MINIO_METADATA_BUCKET:-crawler-metadata}"
      # Job Logs Configuration
      JOB_LOGS_ENABLED: "${JOB_LOGS_ENABLED:-true}"
      JOB_LOGS_BUFFER_SIZE: "${JOB_LOGS_BUFFER_SIZE:-1000}"
      JOB_LOGS_SSE_ENABLED: "${JOB_LOGS_SSE_ENABLED:-true}"
      JOB_LOGS_ARCHIVE_ENABLED: "${JOB_LOGS_ARCHIVE_ENABLED:-true}"
      JOB_LOGS_RETENTION_DAYS: "${JOB_LOGS_RETENTION_DAYS:-30}"
      JOB_LOGS_MIN_LEVEL: "${JOB_LOGS_MIN_LEVEL:-info}"
      JOB_LOGS_MINIO_BUCKET: "${JOB_LOGS_MINIO_BUCKET:-crawler-logs}"
      APP_ENV: production
      AUTH_JWT_SECRET: "${AUTH_JWT_SECRET}"
      SERVER_SECURITY_ENABLED: "false"
      SERVER_PORT: "8080"
      REDIS_ADDR: "${REDIS_HOST:-host.docker.internal}:6379"
      REDIS_PASSWORD: "${REDIS_PASSWORD:-}"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./crawler/config.yml:/app/config.yml:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ------------------------------------------------------------
  # Source Manager (Prod)
  # ------------------------------------------------------------
  source-manager:
    <<: *prod-defaults
    image: docker.io/jonesrussell/source-manager:latest
    depends_on:
      postgres-source-manager:
        condition: service_healthy
    environment:
      APP_DEBUG: "false"
      APP_ENV: production
      SERVER_HOST: "${SOURCE_MANAGER_HOST:-0.0.0.0}"
      SERVER_PORT: "${SOURCE_MANAGER_PORT:-8050}"
      DB_HOST: postgres-source-manager
      DB_PORT: 5432
      DB_USER: "${POSTGRES_SOURCE_MANAGER_USER}"
      DB_PASSWORD: "${POSTGRES_SOURCE_MANAGER_PASSWORD}"
      DB_NAME: "${POSTGRES_SOURCE_MANAGER_DB:-source_manager}"
      DB_SSLMODE: disable
    volumes:
      - ./source-manager/migrations:/migrations:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8050/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ------------------------------------------------------------
  # Publisher (Prod) - Unified API and Router
  # ------------------------------------------------------------
  publisher:
    <<: *prod-defaults
    image: docker.io/jonesrussell/publisher:latest
    command: ["/app/publisher", "both"]
    depends_on:
      postgres-publisher:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    environment:
      POSTGRES_PUBLISHER_HOST: postgres-publisher
      POSTGRES_PUBLISHER_PORT: 5432
      POSTGRES_PUBLISHER_USER: "${POSTGRES_PUBLISHER_USER:-postgres}"
      POSTGRES_PUBLISHER_PASSWORD: "${POSTGRES_PUBLISHER_PASSWORD:-postgres}"
      POSTGRES_PUBLISHER_DB: "${POSTGRES_PUBLISHER_DB:-publisher}"
      POSTGRES_PUBLISHER_SSLMODE: disable
      PUBLISHER_PORT: 8070
      ELASTICSEARCH_URL: http://elasticsearch:9200
      REDIS_ADDR: ${REDIS_HOST:-host.docker.internal}:6379
      REDIS_PASSWORD: "${REDIS_PASSWORD:-}"
      PUBLISHER_ROUTER_CHECK_INTERVAL: "${PUBLISHER_ROUTER_CHECK_INTERVAL:-5m}"
      PUBLISHER_ROUTER_BATCH_SIZE: "${PUBLISHER_ROUTER_BATCH_SIZE:-100}"
      AUTH_JWT_SECRET: "${AUTH_JWT_SECRET}"
      GIN_MODE: release
      APP_DEBUG: "false"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./publisher/config.yml:/app/config.yml:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8070/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 25s

  # ------------------------------------------------------------
  # Classifier (Prod)
  # ------------------------------------------------------------
  classifier:
    <<: *prod-defaults
    image: docker.io/jonesrussell/classifier:latest
    command: ["./classifier", "httpd"]
    depends_on:
      postgres-classifier:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    environment:
      POSTGRES_HOST: postgres-classifier
      POSTGRES_PORT: 5432
      POSTGRES_USER: "${POSTGRES_CLASSIFIER_USER:-postgres}"
      POSTGRES_PASSWORD: "${POSTGRES_CLASSIFIER_PASSWORD:-postgres}"
      POSTGRES_DB: "${POSTGRES_CLASSIFIER_DB:-classifier}"
      POSTGRES_SSLMODE: disable
      ELASTICSEARCH_URL: http://elasticsearch:9200
      ES_URL: http://elasticsearch:9200
      REDIS_URL: ${REDIS_HOST:-host.docker.internal}:6379
      REDIS_PASSWORD: "${REDIS_PASSWORD:-}"
      APP_DEBUG: "false"
      APP_ENV: production
      CLASSIFIER_PORT: 8070
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./classifier/config.yml:/root/config.yml:ro
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8070/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 25s

  # ------------------------------------------------------------
  # Index Manager (Prod)
  # ------------------------------------------------------------
  index-manager:
    <<: *prod-defaults
    image: docker.io/jonesrussell/index-manager:latest
    depends_on:
      postgres-index-manager:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    environment:
      INDEX_MANAGER_PORT: 8090
      POSTGRES_INDEX_MANAGER_HOST: postgres-index-manager
      POSTGRES_INDEX_MANAGER_PORT: 5432
      POSTGRES_INDEX_MANAGER_USER: "${POSTGRES_INDEX_MANAGER_USER}"
      POSTGRES_INDEX_MANAGER_PASSWORD: "${POSTGRES_INDEX_MANAGER_PASSWORD}"
      POSTGRES_INDEX_MANAGER_DB: "${POSTGRES_INDEX_MANAGER_DB:-index_manager}"
      ELASTICSEARCH_URL: http://elasticsearch:9200
      CONFIG_PATH: /root/config.yml
      APP_DEBUG: "false"
      APP_ENV: production
    volumes:
      - ./index-manager/config.yml:/root/config.yml:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ------------------------------------------------------------
  # Search Service (Prod)
  # ------------------------------------------------------------
  search-service:
    <<: *prod-defaults
    image: docker.io/jonesrussell/search-service:latest
    depends_on:
      elasticsearch:
        condition: service_healthy
    environment:
      APP_DEBUG: "false"
      SEARCH_PORT: 8090
      SEARCH_DEBUG: "false"
      ELASTICSEARCH_URL: http://elasticsearch:9200
      ELASTICSEARCH_USERNAME: "${ELASTICSEARCH_USERNAME:-}"
      ELASTICSEARCH_PASSWORD: "${ELASTICSEARCH_PASSWORD:-}"
      LOG_LEVEL: "${SEARCH_LOG_LEVEL:-info}"
      LOG_FORMAT: "${SEARCH_LOG_FORMAT:-json}"
      CORS_ORIGINS: "${CORS_ORIGINS:-*}"
    volumes:
      - ./search/config.yml:/root/config.yml:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ------------------------------------------------------------
  # Search Frontend (Prod)
  # ------------------------------------------------------------
  search-frontend:
    <<: *prod-defaults
    image: docker.io/jonesrussell/search-frontend:latest
    depends_on:
      search-service:
        condition: service_healthy
    environment:
      NODE_ENV: production
      SEARCH_API_URL: http://search-service:8090

  # ------------------------------------------------------------
  # Auth (Prod)
  # ------------------------------------------------------------
  auth:
    <<: *prod-defaults
    image: docker.io/jonesrussell/auth:latest
    environment:
      AUTH_USERNAME: "${AUTH_USERNAME}"
      AUTH_PASSWORD: "${AUTH_PASSWORD}"
      AUTH_JWT_SECRET: "${AUTH_JWT_SECRET}"
      AUTH_PORT: 8040
      APP_DEBUG: "false"
      APP_ENV: production
    volumes:
      - ./auth/config.yml:/app/config.yml:ro
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8040/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ------------------------------------------------------------
  # Dashboard (Prod)
  # ------------------------------------------------------------
  dashboard:
    <<: *prod-defaults
    image: docker.io/jonesrussell/dashboard:latest
    depends_on:
      auth:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:80/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ------------------------------------------------------------
  # Nginx Reverse Proxy (Prod)
  # ------------------------------------------------------------
  nginx:
    <<: *prod-defaults
    image: nginx:alpine
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./infrastructure/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - certbot_etc:/etc/letsencrypt:ro
      - certbot_www:/var/www/certbot
    depends_on:
      source-manager:
        condition: service_healthy
      dashboard:
        condition: service_healthy
      publisher:
        condition: service_healthy
      auth:
        condition: service_healthy
      crawler:
        condition: service_healthy
      classifier:
        condition: service_healthy
      search-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================================
  # Certbot (Prod)
  # ============================================================
  certbot:
    image: certbot/certbot
    networks:
      - north-cloud-network
    volumes:
      - certbot_etc:/etc/letsencrypt
      - certbot_www:/var/www/certbot
    entrypoint: >
      /bin/sh -c '
      trap exit TERM;
      while :; do
        if [ -d /etc/letsencrypt/live ]; then
          echo "[$$(date)] Running certificate renewal check...";
          certbot renew &&
          echo "[$$(date)] Renewal check completed. If renewed, reload nginx with: docker exec north-cloud-nginx nginx -s reload";
        fi;
        sleep 12h & SLEEP_PID=$$!; wait $$SLEEP_PID;
      done;
      '
    restart: always

  # ============================================================
  # Elasticsearch (Prod Overrides)
  # ============================================================
  elasticsearch:
    environment:
      xpack.security.enabled: "${ELASTICSEARCH_SECURITY_ENABLED:-false}"
      ES_JAVA_OPTS: "-Xms${ELASTICSEARCH_MIN_HEAP:-256m} -Xmx${ELASTICSEARCH_MAX_HEAP:-512m}"

  # ============================================================
  # Redis (Prod Overrides)
  # ============================================================
  # Redis is disabled in production - using host Redis instead
  redis:
    profiles:
      - disabled

  # ============================================================
  # Logging Infrastructure (Prod)
  # ============================================================

  loki:
    restart: always
    volumes:
      - ./infrastructure/loki/loki-config.prod.yml:/etc/loki/config.yml:ro
      - loki_data:/loki
    environment:
      LOKI_LOG_LEVEL: info

  alloy:
    restart: always
    volumes:
      - ./infrastructure/alloy/config.alloy:/etc/alloy/config.alloy:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - alloy_data:/var/lib/alloy
    environment:
      ALLOY_LOG_LEVEL: info

  grafana:
    restart: always
    volumes:
      - grafana_data:/var/lib/grafana
      - ./infrastructure/grafana/provisioning:/etc/grafana/provisioning:ro
    environment:
      GF_AUTH_ANONYMOUS_ENABLED: "false"
      GF_SECURITY_ADMIN_PASSWORD: "${GRAFANA_ADMIN_PASSWORD}"
      GF_SERVER_ROOT_URL: "https://northcloud.biz/grafana"
      GF_SERVER_SERVE_FROM_SUB_PATH: "true"
      GF_INSTALL_PLUGINS: "${GRAFANA_INSTALL_PLUGINS:-}"
      GF_LOG_LEVEL: info

# ============================================================
# Production Volumes
# ============================================================
volumes:
  certbot_etc:
    driver: local
  certbot_www:
    driver: local
  loki_data:
    driver: local
  alloy_data:
    driver: local
  grafana_data:
    driver: local
