# ============================================================
# Production Defaults (DRY)
# ============================================================

x-prod-defaults: &prod-defaults
  networks:
    - north-cloud-network
  restart: always
  deploy:
    resources:
      limits:
        cpus: "2"
        memory: 2G
      reservations:
        cpus: "0.5"
        memory: 512M

# ============================================================
# Application Services - Production
# ============================================================

services:

  # ------------------------------------------------------------
  # Crawler (Prod)
  # ------------------------------------------------------------
  crawler:
    <<: *prod-defaults
    build:
      context: .
      dockerfile: ./crawler/Dockerfile
      args:
        BUILD_ENV: production
    depends_on:
      - postgres-crawler
      - elasticsearch
    environment:
      DB_HOST: postgres-crawler
      DB_PORT: 5432
      DB_USER: "${POSTGRES_CRAWLER_USER}"
      DB_PASSWORD: "${POSTGRES_CRAWLER_PASSWORD}"
      DB_NAME: "${POSTGRES_CRAWLER_DB:-crawler}"
      DB_SSLMODE: disable
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
      CRAWLER_SOURCES_API_URL: http://source-manager:8050/api/v1/sources
      CRAWLER_SAVE_DISCOVERED_LINKS: "${CRAWLER_SAVE_DISCOVERED_LINKS:-false}"
      APP_ENV: production
      AUTH_JWT_SECRET: "${AUTH_JWT_SECRET}"

  # ------------------------------------------------------------
  # Source Manager (Prod)
  # ------------------------------------------------------------
  source-manager:
    <<: *prod-defaults
    build:
      context: .
      dockerfile: ./source-manager/Dockerfile
      args:
        BUILD_ENV: production
    depends_on:
      - postgres-source-manager
    environment:
      APP_DEBUG: "false"
      APP_ENV: production
      SERVER_HOST: "${SOURCE_MANAGER_HOST:-0.0.0.0}"
      SERVER_PORT: "${SOURCE_MANAGER_PORT:-8050}"
      DB_HOST: postgres-source-manager
      DB_PORT: 5432
      DB_USER: "${POSTGRES_SOURCE_MANAGER_USER}"
      DB_PASSWORD: "${POSTGRES_SOURCE_MANAGER_PASSWORD}"
      DB_NAME: "${POSTGRES_SOURCE_MANAGER_DB:-gosources}"
      DB_SSLMODE: disable
    volumes:
      - ./source-manager/migrations:/migrations:ro

  # ------------------------------------------------------------
  # Publisher API (Prod)
  # ------------------------------------------------------------
  publisher-api:
    <<: *prod-defaults
    build:
      context: .
      dockerfile: ./publisher/Dockerfile
      args:
        BUILD_ENV: production
    command: ["/app/publisher", "api"]
    depends_on:
      - postgres-publisher
    environment:
      POSTGRES_PUBLISHER_HOST: postgres-publisher
      POSTGRES_PUBLISHER_PORT: 5432
      POSTGRES_PUBLISHER_USER: "${POSTGRES_PUBLISHER_USER}"
      POSTGRES_PUBLISHER_PASSWORD: "${POSTGRES_PUBLISHER_PASSWORD}"
      POSTGRES_PUBLISHER_DB: "${POSTGRES_PUBLISHER_DB:-publisher}"
      POSTGRES_PUBLISHER_SSLMODE: disable
      PUBLISHER_PORT: 8070
      AUTH_JWT_SECRET: "${AUTH_JWT_SECRET}"
      REDIS_ADDR: redis:6379
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
      GIN_MODE: release
      APP_DEBUG: "false"
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 256M

  # ------------------------------------------------------------
  # Publisher Router (Prod)
  # ------------------------------------------------------------
  publisher-router:
    <<: *prod-defaults
    build:
      context: .
      dockerfile: ./publisher/Dockerfile
      args:
        BUILD_ENV: production
    command: ["/app/publisher", "router"]
    depends_on:
      - postgres-publisher
      - elasticsearch
      - redis
    environment:
      POSTGRES_PUBLISHER_HOST: postgres-publisher
      POSTGRES_PUBLISHER_PORT: 5432
      POSTGRES_PUBLISHER_USER: "${POSTGRES_PUBLISHER_USER}"
      POSTGRES_PUBLISHER_PASSWORD: "${POSTGRES_PUBLISHER_PASSWORD}"
      POSTGRES_PUBLISHER_DB: "${POSTGRES_PUBLISHER_DB:-publisher}"
      POSTGRES_PUBLISHER_SSLMODE: disable
      ELASTICSEARCH_URL: http://elasticsearch:9200
      REDIS_ADDR: redis:6379
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
      PUBLISHER_ROUTER_CHECK_INTERVAL: "${PUBLISHER_ROUTER_CHECK_INTERVAL:-5m}"
      PUBLISHER_ROUTER_BATCH_SIZE: "${PUBLISHER_ROUTER_BATCH_SIZE:-100}"
      APP_DEBUG: "false"

  # ------------------------------------------------------------
  # Classifier (Prod)
  # ------------------------------------------------------------
  classifier:
    <<: *prod-defaults
    build:
      context: .
      dockerfile: ./classifier/Dockerfile
      args:
        BUILD_ENV: production
    depends_on:
      - postgres-classifier
      - elasticsearch
      - redis
    environment:
      POSTGRES_HOST: postgres-classifier
      POSTGRES_PORT: 5432
      POSTGRES_USER: "${POSTGRES_CLASSIFIER_USER}"
      POSTGRES_PASSWORD: "${POSTGRES_CLASSIFIER_PASSWORD}"
      POSTGRES_DB: "${POSTGRES_CLASSIFIER_DB:-classifier}"
      POSTGRES_SSLMODE: disable
      ELASTICSEARCH_URL: http://elasticsearch:9200
      ES_URL: http://elasticsearch:9200
      REDIS_URL: redis:6379
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
      APP_DEBUG: "false"
      APP_ENV: production
      CLASSIFIER_PORT: 8070
    volumes:
      - ./classifier/config.yml:/root/config.yml:ro

  # ------------------------------------------------------------
  # Index Manager (Prod)
  # ------------------------------------------------------------
  index-manager:
    <<: *prod-defaults
    build:
      context: ./index-manager
      dockerfile: Dockerfile
      args:
        BUILD_ENV: production
    depends_on:
      - postgres-index-manager
      - elasticsearch
    environment:
      INDEX_MANAGER_PORT: 8090
      POSTGRES_INDEX_MANAGER_HOST: postgres-index-manager
      POSTGRES_INDEX_MANAGER_PORT: 5432
      POSTGRES_INDEX_MANAGER_USER: "${POSTGRES_INDEX_MANAGER_USER}"
      POSTGRES_INDEX_MANAGER_PASSWORD: "${POSTGRES_INDEX_MANAGER_PASSWORD}"
      POSTGRES_INDEX_MANAGER_DB: "${POSTGRES_INDEX_MANAGER_DB:-index_manager}"
      ELASTICSEARCH_URL: http://elasticsearch:9200
      CONFIG_PATH: /root/config.yml
      APP_DEBUG: "false"
      APP_ENV: production
    volumes:
      - ./index-manager/config.yml:/root/config.yml:ro

  # ------------------------------------------------------------
  # Dashboard (Prod)
  # ------------------------------------------------------------
  dashboard:
    <<: *prod-defaults
    build:
      context: ./dashboard
      dockerfile: Dockerfile
      args:
        BUILD_ENV: production
    depends_on:
      - crawler
      - source-manager
      - publisher-api
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:80/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M

  # ------------------------------------------------------------
  # Nginx Reverse Proxy (Prod)
  # ------------------------------------------------------------
  nginx:
    <<: *prod-defaults
    image: nginx:alpine
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./infrastructure/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - certbot_etc:/etc/letsencrypt:ro
      - certbot_www:/var/www/certbot
    depends_on:
      - dashboard
      - classifier
      - crawler
      - publisher-api

  # ============================================================
  # Certbot (Prod)
  # ============================================================
  certbot:
    image: certbot/certbot
    networks:
      - north-cloud-network
    volumes:
      - certbot_etc:/etc/letsencrypt
      - certbot_www:/var/www/certbot
    entrypoint: >
      /bin/sh -c '
      trap exit TERM;
      while :; do
        if [ -d /etc/letsencrypt/live ]; then
          echo "[$$(date)] Running certificate renewal check...";
          certbot renew &&
          echo "[$$(date)] Renewal check completed. If renewed, reload nginx with: docker exec north-cloud-nginx nginx -s reload";
        fi;
        sleep 12h & wait $$$${!};
      done;
      '
    restart: always
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M

  # ============================================================
  # Elasticsearch (Prod Overrides)
  # ============================================================
  elasticsearch:
    environment:
      xpack.security.enabled: "${ELASTICSEARCH_SECURITY_ENABLED:-true}"
      ES_JAVA_OPTS: "-Xms${ELASTICSEARCH_MIN_HEAP:-1g} -Xmx${ELASTICSEARCH_MAX_HEAP:-2g}"
    deploy:
      resources:
        limits:
          cpus: "4"
          memory: 4G
        reservations:
          cpus: "2"
          memory: 2G

  # ============================================================
  # Redis (Prod Overrides)
  # ============================================================
  redis:
    environment:
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M

# ============================================================
# Production Volumes
# ============================================================
volumes:
  certbot_etc:
    driver: local
  certbot_www:
    driver: local
