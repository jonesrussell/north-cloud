name: Integration Tests

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  pipeline:
    name: Pipeline Integration
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: false

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-integration-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-integration-
            ${{ runner.os }}-go-

      - name: Build and start test services
        run: |
          docker compose -f docker-compose.base.yml -f docker-compose.test.yml up -d --build --wait
        env:
          COMPOSE_PROJECT_NAME: north-cloud-test

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to stabilize..."
          sleep 10

          services="auth source-manager index-manager crawler classifier publisher"
          for svc in $services; do
            echo "Checking $svc..."
            for i in $(seq 1 30); do
              if docker compose -f docker-compose.base.yml -f docker-compose.test.yml ps "$svc" | grep -q "healthy"; then
                echo "$svc is healthy"
                break
              fi
              if [ "$i" -eq 30 ]; then
                echo "$svc did not become healthy"
                docker compose -f docker-compose.base.yml -f docker-compose.test.yml logs "$svc"
                exit 1
              fi
              sleep 5
            done
          done
        env:
          COMPOSE_PROJECT_NAME: north-cloud-test

      - name: Run pipeline integration tests
        run: |
          cd tests/integration/pipeline
          GOWORK=off go test -tags integration -v -timeout 10m ./...

      - name: Collect service logs on failure
        if: failure()
        run: |
          mkdir -p /tmp/integration-logs
          docker compose -f docker-compose.base.yml -f docker-compose.test.yml logs --no-color > /tmp/integration-logs/all-services.log 2>&1
        env:
          COMPOSE_PROJECT_NAME: north-cloud-test

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs
          path: /tmp/integration-logs/
          retention-days: 7

      - name: Tear down services
        if: always()
        run: |
          docker compose -f docker-compose.base.yml -f docker-compose.test.yml down -v
        env:
          COMPOSE_PROJECT_NAME: north-cloud-test
