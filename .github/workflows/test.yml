name: Test

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

permissions:
  contents: read

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.detect.outputs.services }}
      has_go: ${{ steps.detect.outputs.has_go }}
      has_frontend: ${{ steps.detect.outputs.has_frontend }}
      run_all: ${{ steps.detect.outputs.run_all }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for diff

      - name: Detect changed services
        id: detect
        env:
          # Use env vars to safely pass GitHub context (avoids injection risks)
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
        run: |
          # Get changed services - use BASE_SHA if available, otherwise HEAD~1
          BASE_REF="${BASE_SHA:-HEAD~1}"
          SERVICES=$(./scripts/detect-changed-services.sh "$BASE_REF")
          echo "Detected changes: $SERVICES"
          echo "services=$SERVICES" >> $GITHUB_OUTPUT

          # Check if "all" or specific services
          if echo "$SERVICES" | grep -q '"all"'; then
            echo "run_all=true" >> $GITHUB_OUTPUT
            echo "has_go=true" >> $GITHUB_OUTPUT
            echo "has_frontend=true" >> $GITHUB_OUTPUT
          else
            echo "run_all=false" >> $GITHUB_OUTPUT
            # Check for Go services
            if echo "$SERVICES" | grep -qE '"(auth|classifier|crawler|index-manager|mcp-north-cloud|pipeline|publisher|search|source-manager|nc-http-proxy)"'; then
              echo "has_go=true" >> $GITHUB_OUTPUT
            else
              echo "has_go=false" >> $GITHUB_OUTPUT
            fi
            # Check for frontend services
            if echo "$SERVICES" | grep -qE '"(dashboard|search-frontend)"'; then
              echo "has_frontend=true" >> $GITHUB_OUTPUT
            else
              echo "has_frontend=false" >> $GITHUB_OUTPUT
            fi
          fi

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.services != '[]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        if: needs.detect-changes.outputs.has_go == 'true' || needs.detect-changes.outputs.run_all == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.26'
          cache: false

      - name: Set up Node.js
        if: needs.detect-changes.outputs.has_frontend == 'true' || needs.detect-changes.outputs.run_all == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '25'
          cache: 'npm'
          cache-dependency-path: |
            dashboard/package-lock.json
            search-frontend/package-lock.json

      - name: Cache Go modules
        if: needs.detect-changes.outputs.has_go == 'true' || needs.detect-changes.outputs.run_all == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install Task runner
        run: |
          sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b ~/.local/bin v3.48.0
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install golangci-lint
        if: needs.detect-changes.outputs.has_go == 'true' || needs.detect-changes.outputs.run_all == 'true'
        uses: golangci/golangci-lint-action@v6
        with:
          version: v2.10.1
          install-only: true

      - name: Install frontend dependencies
        if: needs.detect-changes.outputs.has_frontend == 'true' || needs.detect-changes.outputs.run_all == 'true'
        run: |
          if [ -f "dashboard/package.json" ]; then
            (cd dashboard && npm ci)
          fi
          if [ -f "search-frontend/package.json" ]; then
            (cd search-frontend && npm ci)
          fi

      - name: Run linters (all services)
        if: needs.detect-changes.outputs.run_all == 'true'
        run: task lint

      - name: Run linters (changed services only)
        if: needs.detect-changes.outputs.run_all == 'false'
        env:
          CHANGED_SERVICES: ${{ needs.detect-changes.outputs.services }}
        run: |
          echo "Linting changed services: $CHANGED_SERVICES"

          # Parse JSON and run lint for each service
          for service in $(echo "$CHANGED_SERVICES" | jq -r '.[]'); do
            echo "::group::Linting $service"
            task "lint:$service" || exit 1
            echo "::endgroup::"
          done

  vuln:
    name: Vulnerability Check
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_go == 'true' || needs.detect-changes.outputs.run_all == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.26'
          cache: false

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install Task runner
        run: |
          sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b ~/.local/bin v3.48.0
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Run vulnerability check (all services)
        if: needs.detect-changes.outputs.run_all == 'true'
        run: task vuln

      - name: Run vulnerability check (changed services only)
        if: needs.detect-changes.outputs.run_all == 'false'
        env:
          CHANGED_SERVICES: ${{ needs.detect-changes.outputs.services }}
        run: |
          echo "Checking vulnerabilities for changed services: $CHANGED_SERVICES"

          # Only check Go services
          GO_SERVICES="auth classifier crawler index-manager mcp-north-cloud pipeline publisher search source-manager nc-http-proxy"

          for service in $(echo "$CHANGED_SERVICES" | jq -r '.[]'); do
            if echo "$GO_SERVICES" | grep -qw "$service"; then
              echo "::group::Vulnerability check $service"
              task "vuln:$service" || exit 1
              echo "::endgroup::"
            fi
          done

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: [detect-changes, lint, vuln]
    if: |
      always() &&
      needs.detect-changes.outputs.services != '[]' &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.vuln.result == 'success' || needs.vuln.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        if: needs.detect-changes.outputs.has_go == 'true' || needs.detect-changes.outputs.run_all == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.26'
          cache: false

      - name: Set up Node.js
        if: needs.detect-changes.outputs.has_frontend == 'true' || needs.detect-changes.outputs.run_all == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '25'
          cache: 'npm'
          cache-dependency-path: |
            dashboard/package-lock.json
            search-frontend/package-lock.json

      - name: Cache Go modules
        if: needs.detect-changes.outputs.has_go == 'true' || needs.detect-changes.outputs.run_all == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install Task runner
        run: |
          sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b ~/.local/bin v3.48.0
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install frontend dependencies
        if: needs.detect-changes.outputs.has_frontend == 'true' || needs.detect-changes.outputs.run_all == 'true'
        run: |
          if [ -f "dashboard/package.json" ]; then
            (cd dashboard && npm ci)
          fi
          if [ -f "search-frontend/package.json" ]; then
            (cd search-frontend && npm ci)
          fi

      - name: Run tests (all services)
        if: needs.detect-changes.outputs.run_all == 'true'
        run: task test

      - name: Run tests (changed services only)
        if: needs.detect-changes.outputs.run_all == 'false'
        env:
          CHANGED_SERVICES: ${{ needs.detect-changes.outputs.services }}
        run: |
          echo "Testing changed services: $CHANGED_SERVICES"

          for service in $(echo "$CHANGED_SERVICES" | jq -r '.[]'); do
            echo "::group::Testing $service"
            task "test:$service" || exit 1
            echo "::endgroup::"
          done
