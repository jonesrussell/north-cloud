name: Deploy to Production

on:
  workflow_run:
    workflows: ["Test"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      force_rebuild_all:
        description: 'Force rebuild all services (ignore change detection)'
        required: false
        default: false
        type: boolean
      services:
        description: 'Comma-separated list of services to deploy (empty = auto-detect)'
        required: false
        default: ''
        type: string

env:
  REGISTRY: docker.io
  IMAGE_PREFIX: jonesrussell

permissions:
  contents: read
  packages: write

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')
    outputs:
      # JSON array of services to build
      services_matrix: ${{ steps.changes.outputs.services_matrix }}
      # Comma-separated list for deploy script
      services_list: ${{ steps.changes.outputs.services_list }}
      # Boolean flags for deploy decisions
      has_services: ${{ steps.changes.outputs.has_services }}
      has_infrastructure: ${{ steps.changes.outputs.has_infrastructure }}
      has_migrations: ${{ steps.changes.outputs.has_migrations }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed services
        id: changes
        env:
          # Use env vars to safely pass inputs (avoids injection risks)
          FORCE_ALL: ${{ inputs.force_rebuild_all }}
          MANUAL_SERVICES: ${{ inputs.services }}
          EVENT_NAME: ${{ github.event_name }}
          PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          PUSH_BEFORE_SHA: ${{ github.event.before }}
          TRIGGER_SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          # Determine base and head refs based on event type
          HEAD_REF="HEAD"

          if [ "$EVENT_NAME" = "workflow_run" ] && [ -n "$TRIGGER_SHA" ]; then
            # Pin to the exact commit that triggered the Test workflow.
            # Without this, HEAD may have moved if new commits landed
            # between the Test run and this Deploy run.
            HEAD_REF="$TRIGGER_SHA"
            BASE_REF="${TRIGGER_SHA}^1"
          elif [ "$EVENT_NAME" = "pull_request" ] && [ -n "$PR_BASE_SHA" ]; then
            BASE_REF="$PR_BASE_SHA"
          elif [ -n "$PUSH_BEFORE_SHA" ] && [ "$PUSH_BEFORE_SHA" != "0000000000000000000000000000000000000000" ]; then
            BASE_REF="$PUSH_BEFORE_SHA"
          else
            BASE_REF="HEAD~1"
          fi

          # Use shared detection script with deploy format
          # Script reads FORCE_ALL, MANUAL_SERVICES, and HEAD_REF from env
          export HEAD_REF
          ./scripts/detect-changed-services.sh "$BASE_REF" --format=deploy >> $GITHUB_OUTPUT

          echo ""
          echo "=== Detection Summary ==="
          ./scripts/detect-changed-services.sh "$BASE_REF" --format=deploy

  build-and-push:
    name: Build ${{ matrix.service.name }}
    needs: detect-changes
    if: needs.detect-changes.outputs.has_services == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.services_matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service.name }}
          tags: |
            type=raw,value=latest
            type=sha,format=short

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: |
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service.name }}:buildcache
            type=gha,scope=${{ matrix.service.name }}
          cache-to: |
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service.name }}:buildcache,mode=max
            type=gha,scope=${{ matrix.service.name }},mode=max
          build-args: |
            BUILD_ENV=production

  deploy:
    name: Deploy to Production
    needs: [detect-changes, build-and-push]
    # Run if services were built OR if only infrastructure changed
    if: |
      always() &&
      needs.detect-changes.result == 'success' &&
      (needs.build-and-push.result == 'success' || needs.build-and-push.result == 'skipped') &&
      (needs.detect-changes.outputs.has_services == 'true' || needs.detect-changes.outputs.has_infrastructure == 'true')
    runs-on: ubuntu-latest
    env:
      CHANGED_SERVICES: ${{ needs.detect-changes.outputs.services_list }}
      INFRA_CHANGED: ${{ needs.detect-changes.outputs.has_infrastructure }}
      MIGRATIONS_CHANGED: ${{ needs.detect-changes.outputs.has_migrations }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.DEPLOY_SSH_PORT || 22 }} ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Sync files to server
        env:
          SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT || 22 }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          # Create a tarball of all deployment files (faster than multiple scp)
          tar -czf /tmp/deploy-files.tar.gz \
            docker-compose.base.yml \
            docker-compose.prod.yml \
            scripts/deploy.sh \
            infrastructure/ \
            */migrations/ \
            --exclude='*.md' \
            --exclude='*.txt' \
            2>/dev/null || true

          # Transfer and extract in one operation
          scp -P "${SSH_PORT}" /tmp/deploy-files.tar.gz "${DEPLOY_USER}@${DEPLOY_HOST}:/tmp/"

          ssh -p "${SSH_PORT}" "${DEPLOY_USER}@${DEPLOY_HOST}" '
            cd /opt/north-cloud
            tar -xzf /tmp/deploy-files.tar.gz
            rm /tmp/deploy-files.tar.gz
            chmod +x scripts/deploy.sh 2>/dev/null || chmod +x deploy.sh 2>/dev/null || true
            # Move deploy.sh to expected location if it was in scripts/
            [ -f scripts/deploy.sh ] && mv scripts/deploy.sh deploy.sh
          '

      - name: Deploy services
        env:
          SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT || 22 }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          ssh -p "${SSH_PORT}" "${DEPLOY_USER}@${DEPLOY_HOST}" "
            cd /opt/north-cloud

            # Export variables for deploy script
            export CHANGED_SERVICES='${CHANGED_SERVICES}'
            export INFRA_CHANGED='${INFRA_CHANGED}'
            export MIGRATIONS_CHANGED='${MIGRATIONS_CHANGED}'

            # Run optimized deploy
            bash deploy.sh
          "
