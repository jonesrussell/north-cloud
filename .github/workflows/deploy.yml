name: Deploy to Production

on:
  workflow_run:
    workflows: ["Test"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      force_rebuild_all:
        description: 'Force rebuild all services (ignore change detection)'
        required: false
        default: false
        type: boolean
      services:
        description: 'Comma-separated list of services to deploy (empty = auto-detect)'
        required: false
        default: ''
        type: string

env:
  REGISTRY: docker.io
  IMAGE_PREFIX: jonesrussell

permissions:
  contents: read
  packages: write

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')
    outputs:
      # JSON array of services to build
      services_matrix: ${{ steps.changes.outputs.services_matrix }}
      # Comma-separated list for deploy script
      services_list: ${{ steps.changes.outputs.services_list }}
      # Boolean flags for deploy decisions
      has_services: ${{ steps.changes.outputs.has_services }}
      has_infrastructure: ${{ steps.changes.outputs.has_infrastructure }}
      has_migrations: ${{ steps.changes.outputs.has_migrations }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed services
        id: changes
        env:
          FORCE_REBUILD: ${{ inputs.force_rebuild_all }}
          MANUAL_SERVICES: ${{ inputs.services }}
        run: |
          # All available services
          ALL_SERVICES="auth crawler source-manager classifier publisher index-manager search-service search-frontend dashboard nc-http-proxy"

          # Handle manual service list
          if [ -n "$MANUAL_SERVICES" ]; then
            echo "Manual services specified: $MANUAL_SERVICES"
            CHANGED_SERVICES="$MANUAL_SERVICES"
          # Handle force rebuild
          elif [ "$FORCE_REBUILD" == "true" ]; then
            echo "Force rebuild requested"
            CHANGED_SERVICES="$ALL_SERVICES"
          else
            # Detect changes from git
            if [ "${{ github.event_name }}" == "workflow_run" ]; then
              # For workflow_run, compare HEAD with HEAD~1 (last commit)
              BASE_SHA="HEAD~1"
              HEAD_SHA="HEAD"
            elif [ "${{ github.event_name }}" == "pull_request" ]; then
              BASE_SHA="${{ github.event.pull_request.base.sha }}"
              HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            else
              BASE_SHA="${{ github.event.before }}"
              HEAD_SHA="${{ github.sha }}"
            fi

            # Validate BASE_SHA
            if [ -z "$BASE_SHA" ] || [ "$BASE_SHA" == "0000000000000000000000000000000000000000" ]; then
              BASE_SHA="HEAD~1"
            fi
            if ! git cat-file -e "$BASE_SHA" 2>/dev/null; then
              echo "Warning: BASE_SHA invalid, using HEAD~1"
              BASE_SHA="HEAD~1"
            fi

            CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA 2>/dev/null || echo "")

            if [ -z "$CHANGED_FILES" ]; then
              echo "No changed files detected, building all"
              CHANGED_SERVICES="$ALL_SERVICES"
            else
              echo "Changed files:"
              echo "$CHANGED_FILES"
              echo ""

              CHANGED_SERVICES=""

              # Map directories to services
              echo "$CHANGED_FILES" | grep -q "^auth/" && CHANGED_SERVICES="$CHANGED_SERVICES auth"
              echo "$CHANGED_FILES" | grep -q "^crawler/" && CHANGED_SERVICES="$CHANGED_SERVICES crawler"
              echo "$CHANGED_FILES" | grep -q "^source-manager/" && CHANGED_SERVICES="$CHANGED_SERVICES source-manager"
              echo "$CHANGED_FILES" | grep -q "^classifier/" && CHANGED_SERVICES="$CHANGED_SERVICES classifier"
              echo "$CHANGED_FILES" | grep -q "^publisher/" && CHANGED_SERVICES="$CHANGED_SERVICES publisher"
              echo "$CHANGED_FILES" | grep -q "^index-manager/" && CHANGED_SERVICES="$CHANGED_SERVICES index-manager"
              echo "$CHANGED_FILES" | grep -q "^search/" && CHANGED_SERVICES="$CHANGED_SERVICES search-service"
              echo "$CHANGED_FILES" | grep -q "^search-frontend/" && CHANGED_SERVICES="$CHANGED_SERVICES search-frontend"
              echo "$CHANGED_FILES" | grep -q "^dashboard/" && CHANGED_SERVICES="$CHANGED_SERVICES dashboard"
              echo "$CHANGED_FILES" | grep -q "^nc-http-proxy/" && CHANGED_SERVICES="$CHANGED_SERVICES nc-http-proxy"

              # Trim whitespace
              CHANGED_SERVICES=$(echo "$CHANGED_SERVICES" | xargs)
            fi
          fi

          # Detect infrastructure changes (needs sync but not rebuild)
          INFRA_CHANGED="false"
          if [ -n "$CHANGED_FILES" ]; then
            if echo "$CHANGED_FILES" | grep -qE "^infrastructure/|^scripts/|docker-compose\.(base|prod)\.yml|^\.github/"; then
              INFRA_CHANGED="true"
            fi
          fi

          # Detect migration changes
          MIGRATIONS_CHANGED="false"
          if [ -n "$CHANGED_FILES" ]; then
            if echo "$CHANGED_FILES" | grep -q "/migrations/"; then
              MIGRATIONS_CHANGED="true"
            fi
          fi

          # Build matrix JSON
          if [ -n "$CHANGED_SERVICES" ]; then
            # Convert space-separated to JSON array of objects
            MATRIX_JSON="["
            FIRST=true
            for svc in $CHANGED_SERVICES; do
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                MATRIX_JSON="$MATRIX_JSON,"
              fi

              # Map service name to context/dockerfile
              case "$svc" in
                search-service)
                  CONTEXT="."
                  DOCKERFILE="./search/Dockerfile"
                  ;;
                search-frontend)
                  CONTEXT="./search-frontend"
                  DOCKERFILE="./search-frontend/Dockerfile"
                  ;;
                dashboard)
                  CONTEXT="./dashboard"
                  DOCKERFILE="./dashboard/Dockerfile"
                  ;;
                nc-http-proxy)
                  CONTEXT="./nc-http-proxy"
                  DOCKERFILE="./nc-http-proxy/Dockerfile"
                  ;;
                *)
                  CONTEXT="."
                  DOCKERFILE="./${svc}/Dockerfile"
                  ;;
              esac

              MATRIX_JSON="$MATRIX_JSON{\"name\":\"$svc\",\"context\":\"$CONTEXT\",\"dockerfile\":\"$DOCKERFILE\"}"
            done
            MATRIX_JSON="$MATRIX_JSON]"

            echo "services_matrix={\"service\":$MATRIX_JSON}" >> $GITHUB_OUTPUT
            echo "services_list=$(echo $CHANGED_SERVICES | tr ' ' ',')" >> $GITHUB_OUTPUT
            echo "has_services=true" >> $GITHUB_OUTPUT
          else
            echo "services_matrix={\"service\":[]}" >> $GITHUB_OUTPUT
            echo "services_list=" >> $GITHUB_OUTPUT
            echo "has_services=false" >> $GITHUB_OUTPUT
          fi

          echo "has_infrastructure=$INFRA_CHANGED" >> $GITHUB_OUTPUT
          echo "has_migrations=$MIGRATIONS_CHANGED" >> $GITHUB_OUTPUT

          echo ""
          echo "=== Summary ==="
          echo "Services to build: ${CHANGED_SERVICES:-none}"
          echo "Infrastructure changed: $INFRA_CHANGED"
          echo "Migrations changed: $MIGRATIONS_CHANGED"

  build-and-push:
    name: Build ${{ matrix.service.name }}
    needs: detect-changes
    if: needs.detect-changes.outputs.has_services == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.services_matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service.name }}
          tags: |
            type=raw,value=latest
            type=sha,format=short

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: |
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service.name }}:buildcache
            type=gha,scope=${{ matrix.service.name }}
          cache-to: |
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service.name }}:buildcache,mode=max
            type=gha,scope=${{ matrix.service.name }},mode=max
          build-args: |
            BUILD_ENV=production

  deploy:
    name: Deploy to Production
    needs: [detect-changes, build-and-push]
    # Run if services were built OR if only infrastructure changed
    if: |
      always() &&
      needs.detect-changes.result == 'success' &&
      (needs.build-and-push.result == 'success' || needs.build-and-push.result == 'skipped') &&
      (needs.detect-changes.outputs.has_services == 'true' || needs.detect-changes.outputs.has_infrastructure == 'true')
    runs-on: ubuntu-latest
    env:
      CHANGED_SERVICES: ${{ needs.detect-changes.outputs.services_list }}
      INFRA_CHANGED: ${{ needs.detect-changes.outputs.has_infrastructure }}
      MIGRATIONS_CHANGED: ${{ needs.detect-changes.outputs.has_migrations }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.DEPLOY_SSH_PORT || 22 }} ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Sync files to server
        env:
          SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT || 22 }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          # Create a tarball of all deployment files (faster than multiple scp)
          tar -czf /tmp/deploy-files.tar.gz \
            docker-compose.base.yml \
            docker-compose.prod.yml \
            scripts/deploy.sh \
            infrastructure/ \
            */migrations/ \
            --exclude='*.md' \
            --exclude='*.txt' \
            2>/dev/null || true

          # Transfer and extract in one operation
          scp -P "${SSH_PORT}" /tmp/deploy-files.tar.gz "${DEPLOY_USER}@${DEPLOY_HOST}:/tmp/"

          ssh -p "${SSH_PORT}" "${DEPLOY_USER}@${DEPLOY_HOST}" '
            cd /opt/north-cloud
            tar -xzf /tmp/deploy-files.tar.gz
            rm /tmp/deploy-files.tar.gz
            chmod +x scripts/deploy.sh 2>/dev/null || chmod +x deploy.sh 2>/dev/null || true
            # Move deploy.sh to expected location if it was in scripts/
            [ -f scripts/deploy.sh ] && mv scripts/deploy.sh deploy.sh
          '

      - name: Deploy services
        env:
          SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT || 22 }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          ssh -p "${SSH_PORT}" "${DEPLOY_USER}@${DEPLOY_HOST}" "
            cd /opt/north-cloud

            # Export variables for deploy script
            export CHANGED_SERVICES='${CHANGED_SERVICES}'
            export INFRA_CHANGED='${INFRA_CHANGED}'
            export MIGRATIONS_CHANGED='${MIGRATIONS_CHANGED}'

            # Run optimized deploy
            bash deploy.sh
          "
